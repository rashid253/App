<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Commerce App</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: #f8fafc;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(102,126,234,0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .business-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .business-logo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .business-details h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .business-details p {
            font-size: 12px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            position: relative;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* Search Bar */
        .search-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .search-bar i {
            color: white;
            font-size: 16px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .search-bar input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        /* Categories */
        .categories-section {
            padding: 20px;
            background: white;
            border-radius: 30px 30px 0 0;
            margin-top: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .section-header a {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .category-card {
            text-align: center;
        }

        .category-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(102,126,234,0.3);
        }

        .category-card span {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        /* Products Grid */
        .products-section {
            padding: 0 20px 20px;
            background: white;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .product-info {
            padding: 12px;
        }

        .product-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 40px;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .current-price {
            font-size: 16px;
            font-weight: 800;
            color: #10b981;
        }

        .original-price {
            font-size: 12px;
            color: #94a3b8;
            text-decoration: line-through;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .btn-add {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-buy {
            width: 40px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Floating Cart */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: calc(100% - 40px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 60px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 10px 40px rgba(102,126,234,0.4);
            cursor: pointer;
            z-index: 1000;
        }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cart-icon {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .cart-total {
            font-weight: 700;
            font-size: 16px;
        }

        .checkout-btn {
            background: white;
            color: #667eea;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .close-modal {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #64748b;
        }

        .modal-body {
            padding: 20px;
        }

        /* Cart Item */
        .cart-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .cart-item-image {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .cart-item-price {
            color: #10b981;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            font-weight: 700;
        }

        .qty-value {
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .remove-item {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
        }

        /* Checkout Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Payment Methods */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .payment-method {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
        }

        .payment-method.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .payment-method i {
            font-size: 24px;
            margin-bottom: 5px;
            color: #667eea;
        }

        .payment-method span {
            display: block;
            font-weight: 600;
            font-size: 12px;
        }

        /* Order Summary */
        .order-summary {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin: 15px 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #475569;
            font-size: 14px;
        }

        .summary-row.total {
            font-weight: 700;
            color: #1e293b;
            font-size: 18px;
            border-top: 2px solid #e2e8f0;
            padding-top: 10px;
        }

        /* Token Display */
        .token-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            margin: 15px 0;
        }

        .token-code {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        /* Order Ticket */
        .order-ticket {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px dashed #667eea;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .ticket-status {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #e2e8f0;
            z-index: 100;
        }

        .nav-item {
            text-align: center;
            color: #94a3b8;
            cursor: pointer;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 600;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            animation: slideDown 0.3s;
            max-width: 90%;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="header-top">
                <div class="business-info">
                    <div class="business-logo" id="businessLogo"></div>
                    <div class="business-details">
                        <h1 id="businessName">Loading...</h1>
                        <p id="businessStatus">Open Now</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="header-icon" onclick="window.location.href='tracking.html'">
                        <i class="fas fa-truck"></i>
                        <span class="badge" id="trackingBadge" style="display:none;">0</span>
                    </div>
                    <div class="header-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationBadge" style="display:none;">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Search -->
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search products..." id="searchInput">
            </div>
        </div>

        <!-- Categories -->
        <div class="categories-section">
            <div class="section-header">
                <h2>Categories</h2>
                <a href="#" onclick="showAllProducts()">See All</a>
            </div>
            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories loaded dynamically -->
            </div>
        </div>

        <!-- Products -->
        <div class="products-section">
            <div class="section-header">
                <h2>Featured Products</h2>
                <a href="#" onclick="showAllProducts()">View All</a>
            </div>
            <div class="products-grid" id="productsGrid">
                <!-- Products loaded dynamically -->
            </div>
        </div>

        <!-- Floating Cart -->
        <div class="floating-cart" id="floatingCart" onclick="openCart()">
            <div class="cart-info">
                <div class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <span class="cart-total" id="cartTotal">PKR 0</span>
            </div>
            <div class="checkout-btn">
                Checkout
            </div>
        </div>

        <!-- Cart Modal -->
        <div class="modal" id="cartModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Your Cart</h2>
                    <div class="close-modal" onclick="closeCart()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="modal-body" id="cartItems">
                    <!-- Cart items loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div class="modal" id="checkoutModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Checkout</h2>
                    <div class="close-modal" onclick="closeCheckout()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="modal-body" id="checkoutContent">
                    <!-- Checkout form loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Order Confirmation Modal -->
        <div class="modal" id="orderModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Order Confirmed! ðŸŽ‰</h2>
                    <div class="close-modal" onclick="closeOrderModal()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="modal-body" id="orderContent">
                    <!-- Order details loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Payment Details Modal -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="paymentTitle">Payment Details</h2>
                    <div class="close-modal" onclick="closePaymentModal()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="modal-body" id="paymentContent">
                    <!-- Payment details loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="navigateTo('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="navigateTo('categories')">
                <i class="fas fa-th-large"></i>
                <span>Categories</span>
            </div>
            <div class="nav-item" onclick="navigateTo('orders')">
                <i class="fas fa-truck"></i>
                <span>Orders</span>
            </div>
            <div class="nav-item" onclick="navigateTo('profile')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase with your credentials
        const supabase = supabase.createClient(
            "https://dfvnefbxgayxqgjjgtrr.supabase.co",
            "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
        );

        // App State
        let currentBusiness = null;
        let products = [];
        let cart = [];
        let categories = [];
        let customerInfo = {
            phone: localStorage.getItem('customerPhone') || '',
            address: localStorage.getItem('customerAddress') || '',
            name: ''
        };
        let selectedPaymentMethod = 'cod';
        let deliveryCharge = 0;
        let deliveryTime = '';
        let detectedZone = '';

        // ========== LOAD BUSINESS DATA ==========
        async function loadBusiness() {
            const urlParams = new URLSearchParams(window.location.search);
            let businessId = urlParams.get('id') || localStorage.getItem('lastBusinessId');
            
            if (!businessId) {
                showNotification('Please scan a business QR code first');
                return;
            }

            try {
                // Check if it's a short ID
                if (businessId.length === 6) {
                    const { data: mapping } = await supabase
                        .from('short_urls')
                        .select('full_id')
                        .eq('short_id', businessId)
                        .single();
                    
                    if (mapping) {
                        businessId = mapping.full_id;
                    }
                }

                // Load card data
                const { data: card, error } = await supabase
                    .from('cards')
                    .select('*')
                    .eq('id', businessId)
                    .single();

                if (error) throw error;

                currentBusiness = JSON.parse(card.data);
                currentBusiness.id = card.id;
                
                // Store business ID
                localStorage.setItem('lastBusinessId', businessId);
                
                // Update UI
                updateBusinessInfo();
                loadProducts();
                loadCategories();
                
                // Load saved cart
                const savedCart = localStorage.getItem(`cart_${businessId}`);
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    updateCartUI();
                }
                
                // Start real-time subscriptions
                subscribeToOrders();
                
            } catch (error) {
                console.error('Error loading business:', error);
                showNotification('Error loading business data');
            }
        }

        function updateBusinessInfo() {
            if (!currentBusiness) return;
            
            const name = currentBusiness.businessName || currentBusiness.name || 'Business';
            document.getElementById('businessName').textContent = name;
            
            const logo = document.getElementById('businessLogo');
            if (currentBusiness.profileImage) {
                logo.innerHTML = `<img src="${currentBusiness.profileImage}" style="width:50px;height:50px;border-radius:12px;object-fit:cover;">`;
            } else {
                logo.textContent = name.charAt(0).toUpperCase();
            }
            
            // Check business hours
            updateBusinessStatus();
        }

        function updateBusinessStatus() {
            if (!currentBusiness.businessHours) return;
            
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayIndex = day === 0 ? 6 : day - 1; // Convert to Monday=0 format
            
            const todayHours = currentBusiness.businessHours[dayIndex];
            const statusEl = document.getElementById('businessStatus');
            
            if (todayHours && todayHours.status === 'open' && todayHours.start && todayHours.end) {
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const [startHour, startMin] = todayHours.start.split(':').map(Number);
                const [endHour, endMin] = todayHours.end.split(':').map(Number);
                const startTime = startHour * 60 + startMin;
                const endTime = endHour * 60 + endMin;
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    statusEl.textContent = 'Open Now';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = 'Closed';
                    statusEl.style.color = '#ef4444';
                }
            } else {
                statusEl.textContent = 'Hours not set';
                statusEl.style.color = '#f59e0b';
            }
        }

        // ========== PRODUCTS ==========
        function loadProducts() {
            if (!currentBusiness || !currentBusiness.products) return;
            
            products = currentBusiness.products;
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            products.slice(0, 4).forEach((product, index) => {
                productsGrid.appendChild(createProductCard(product, index));
            });
        }

        function createProductCard(product, index) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const price = product.discountPrice || product.originalPrice;
            const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
            
            card.innerHTML = `
                <img src="${product.image || 'https://via.placeholder.com/200'}" class="product-image" onerror="this.src='https://via.placeholder.com/200'">
                <div class="product-info">
                    <div class="product-title">${product.title || 'Product'}</div>
                    <div class="product-price">
                        <span class="current-price">PKR ${price}</span>
                        ${originalPrice ? `<span class="original-price">PKR ${originalPrice}</span>` : ''}
                    </div>
                    <div class="product-actions">
                        <button class="btn-add" onclick="addToCart(${index})">
                            <i class="fas fa-cart-plus"></i> Add
                        </button>
                        <button class="btn-buy" onclick="buyNow(${index})">
                            <i class="fas fa-bolt"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function loadCategories() {
            if (!products.length) return;
            
            // Extract unique categories from products
            const uniqueCategories = [...new Set(products.map(p => p.category || 'Uncategorized'))];
            categories = uniqueCategories.slice(0, 4);
            
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';
            
            const icons = ['fa-mobile', 'fa-tshirt', 'fa-laptop', 'fa-utensils', 'fa-book', 'fa-gift'];
            
            categories.forEach((category, index) => {
                categoriesGrid.innerHTML += `
                    <div class="category-card" onclick="filterByCategory('${category}')">
                        <div class="category-icon">
                            <i class="fas ${icons[index % icons.length]}"></i>
                        </div>
                        <span>${category}</span>
                    </div>
                `;
            });
        }

        function filterByCategory(category) {
            const filtered = products.filter(p => (p.category || 'Uncategorized') === category);
            showProducts(filtered);
        }

        function showAllProducts() {
            showProducts(products);
        }

        function showProducts(productsToShow) {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            productsToShow.forEach((product, index) => {
                productsGrid.appendChild(createProductCard(product, index));
            });
        }

        // ========== CART FUNCTIONS ==========
        function addToCart(index) {
            const product = products[index];
            const existing = cart.find(item => item.title === product.title);
            
            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1,
                    index: index
                });
            }
            
            saveCart();
            updateCartUI();
            showNotification('âœ… Added to cart');
        }

        function buyNow(index) {
            addToCart(index);
            openCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
            renderCart();
        }

        function updateQuantity(index, change) {
            if (cart[index]) {
                cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change);
                saveCart();
                updateCartUI();
                renderCart();
            }
        }

        function saveCart() {
            if (currentBusiness) {
                localStorage.setItem(`cart_${currentBusiness.id}`, JSON.stringify(cart));
            }
        }

        function updateCartUI() {
            const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            const total = cart.reduce((sum, item) => {
                const price = item.discountPrice || item.originalPrice || 0;
                return sum + (price * (item.quantity || 1));
            }, 0);
            
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = `PKR ${total.toFixed(2)}`;
            
            if (count > 0) {
                document.getElementById('floatingCart').style.display = 'flex';
            } else {
                document.getElementById('floatingCart').style.display = 'none';
            }
        }

        // ========== CART MODAL ==========
        function openCart() {
            renderCart();
            document.getElementById('cartModal').classList.add('active');
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }

        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <i class="fas fa-shopping-cart" style="font-size:60px; color:#cbd5e1; margin-bottom:20px;"></i>
                        <h3 style="color:#1e293b;">Your cart is empty</h3>
                        <p style="color:#64748b; margin:10px 0;">Add some products to get started</p>
                        <button onclick="closeCart()" style="padding:12px 30px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:12px; font-weight:600; cursor:pointer;">
                            Browse Products
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let subtotal = 0;
            
            cart.forEach((item, index) => {
                const price = item.discountPrice || item.originalPrice || 0;
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;
                
                html += `
                    <div class="cart-item">
                        <img src="${item.image || 'https://via.placeholder.com/70'}" class="cart-item-image" onerror="this.src='https://via.placeholder.com/70'">
                        <div class="cart-item-details">
                            <div class="cart-item-title">${item.title || 'Product'}</div>
                            <div class="cart-item-price">PKR ${itemTotal.toFixed(2)}</div>
                            <div class="cart-item-quantity">
                                <button class="qty-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                <span class="qty-value">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                                <span class="remove-item" onclick="removeFromCart(${index})">Remove</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:12px;">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>PKR ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery</span>
                        <span>Calculated at checkout</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span>PKR ${subtotal.toFixed(2)}</span>
                    </div>
                    <button onclick="openCheckout()" style="width:100%; padding:15px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; border:none; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer; margin-top:15px;">
                        Proceed to Checkout
                    </button>
                </div>
            `;
            
            cartItems.innerHTML = html;
        }

        // ========== CHECKOUT ==========
        function openCheckout() {
            closeCart();
            
            // Check if customer has phone and address
            if (!customerInfo.phone) {
                showAddressPrompt();
                return;
            }
            
            renderCheckout();
            document.getElementById('checkoutModal').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        function renderCheckout() {
            const checkoutContent = document.getElementById('checkoutContent');
            
            let subtotal = cart.reduce((sum, item) => {
                const price = item.discountPrice || item.originalPrice || 0;
                return sum + (price * item.quantity);
            }, 0);
            
            // Calculate delivery if address exists
            if (customerInfo.address) {
                calculateDelivery(customerInfo.address);
            }
            
            // Get payment methods from business
            const paymentMethods = currentBusiness?.payments?.gateways || {};
            
            let paymentHtml = '';
            
            // COD
            if (paymentMethods.cod?.active !== false) {
                paymentHtml += `
                    <div class="payment-method ${selectedPaymentMethod === 'cod' ? 'selected' : ''}" onclick="selectPaymentMethod('cod')">
                        <i class="fas fa-truck"></i>
                        <span>Cash on Delivery</span>
                    </div>
                `;
            }
            
            // JazzCash
            if (paymentMethods.jazzcash?.active) {
                paymentHtml += `
                    <div class="payment-method ${selectedPaymentMethod === 'jazzcash' ? 'selected' : ''}" onclick="selectPaymentMethod('jazzcash')">
                        <i class="fas fa-mobile-alt"></i>
                        <span>JazzCash</span>
                    </div>
                `;
            }
            
            // EasyPaisa
            if (paymentMethods.easypaisa?.active) {
                paymentHtml += `
                    <div class="payment-method ${selectedPaymentMethod === 'easypaisa' ? 'selected' : ''}" onclick="selectPaymentMethod('easypaisa')">
                        <i class="fas fa-wallet"></i>
                        <span>EasyPaisa</span>
                    </div>
                `;
            }
            
            // Bank Transfer
            if (paymentMethods.bank?.active) {
                paymentHtml += `
                    <div class="payment-method ${selectedPaymentMethod === 'bank' ? 'selected' : ''}" onclick="selectPaymentMethod('bank')">
                        <i class="fas fa-university"></i>
                        <span>Bank Transfer</span>
                    </div>
                `;
            }
            
            checkoutContent.innerHTML = `
                <div style="margin-bottom:20px;">
                    <h3 style="margin-bottom:15px;">Delivery Information</h3>
                    
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="checkoutPhone" value="${customerInfo.phone}" placeholder="03XXXXXXXXX">
                    </div>
                    
                    <div class="form-group">
                        <label>Delivery Address</label>
                        <textarea id="checkoutAddress" placeholder="Complete address">${customerInfo.address}</textarea>
                    </div>
                    
                    <div style="background:#f0f9ff; border-radius:12px; padding:15px; margin:15px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Delivery Zone:</span>
                            <span style="font-weight:700;" id="deliveryZone">${detectedZone || 'Not calculated'}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>Delivery Time:</span>
                            <span style="font-weight:700; color:#10b981;" id="deliveryTime">${deliveryTime || 'Enter address'}</span>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin:20px 0 15px;">Payment Method</h3>
                <div class="payment-methods" id="paymentMethods">
                    ${paymentHtml}
                </div>
                
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>PKR ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Charge</span>
                        <span id="summaryDelivery">PKR ${deliveryCharge.toFixed(2)}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="summaryTotal">PKR ${(subtotal + deliveryCharge).toFixed(2)}</span>
                    </div>
                </div>
                
                <button onclick="placeOrder()" style="width:100%; padding:18px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; border:none; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer;">
                    Place Order & Generate Token
                </button>
            `;
            
            // Add event listeners
            document.getElementById('checkoutPhone').addEventListener('input', (e) => {
                customerInfo.phone = e.target.value;
                localStorage.setItem('customerPhone', e.target.value);
            });
            
            document.getElementById('checkoutAddress').addEventListener('input', (e) => {
                customerInfo.address = e.target.value;
                localStorage.setItem('customerAddress', e.target.value);
                calculateDelivery(e.target.value);
            });
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            event.target.closest('.payment-method').classList.add('selected');
            
            // Show payment details if needed
            if (method !== 'cod') {
                showPaymentDetails(method);
            }
        }

        function showPaymentDetails(method) {
            const paymentMethods = currentBusiness?.payments?.gateways || {};
            const paymentContent = document.getElementById('paymentContent');
            const title = document.getElementById('paymentTitle');
            
            let html = '';
            
            switch(method) {
                case 'jazzcash':
                    title.innerHTML = 'JazzCash Payment';
                    html = `
                        <div style="text-align:center;">
                            <div style="background:rgba(255,107,0,0.1); padding:20px; border-radius:16px; margin:20px 0;">
                                <h3 style="color:#FF6B00; margin-bottom:10px;">Send to:</h3>
                                <div style="font-size:24px; font-weight:800; color:#FF6B00;">${paymentMethods.jazzcash?.number || '03001234567'}</div>
                            </div>
                            ${paymentMethods.jazzcash?.barcode ? `
                                <div style="margin:20px 0;">
                                    <p>Scan to Pay:</p>
                                    <img src="${paymentMethods.jazzcash.barcode}" style="max-width:200px; border-radius:12px;">
                                </div>
                            ` : ''}
                        </div>
                    `;
                    break;
                    
                case 'easypaisa':
                    title.innerHTML = 'EasyPaisa Payment';
                    html = `
                        <div style="text-align:center;">
                            <div style="background:rgba(10,92,54,0.1); padding:20px; border-radius:16px; margin:20px 0;">
                                <h3 style="color:#0A5C36; margin-bottom:10px;">Send to:</h3>
                                <div style="font-size:24px; font-weight:800; color:#0A5C36;">${paymentMethods.easypaisa?.number || '03001234567'}</div>
                            </div>
                            ${paymentMethods.easypaisa?.barcode ? `
                                <div style="margin:20px 0;">
                                    <p>Scan to Pay:</p>
                                    <img src="${paymentMethods.easypaisa.barcode}" style="max-width:200px; border-radius:12px;">
                                </div>
                            ` : ''}
                        </div>
                    `;
                    break;
                    
                case 'bank':
                    title.innerHTML = 'Bank Transfer';
                    html = `
                        <div style="background:#f8fafc; border-radius:16px; padding:20px;">
                            <div style="margin-bottom:15px;">
                                <label style="color:#64748b;">Bank</label>
                                <div style="font-weight:700;">${paymentMethods.bank?.bankName || 'HBL'}</div>
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="color:#64748b;">Account Title</label>
                                <div style="font-weight:700;">${paymentMethods.bank?.accountTitle || 'Business Account'}</div>
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="color:#64748b;">Account Number</label>
                                <div style="font-size:20px; font-weight:800; color:#2563eb;">${paymentMethods.bank?.accountNumber || '1234567890'}</div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            html += `
                <button onclick="continueAfterPayment()" style="width:100%; padding:15px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; border:none; border-radius:12px; font-weight:600; margin-top:20px; cursor:pointer;">
                    I've Made the Payment
                </button>
            `;
            
            paymentContent.innerHTML = html;
            document.getElementById('paymentModal').classList.add('active');
        }

        function continueAfterPayment() {
            closePaymentModal();
            placeOrder();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        // ========== DELIVERY CALCULATION ==========
        function calculateDelivery(address) {
            if (!address) {
                deliveryCharge = 0;
                deliveryTime = 'Enter address';
                detectedZone = 'Unknown';
                updateDeliveryUI();
                return;
            }
            
            const addressLower = address.toLowerCase();
            
            // Use business delivery settings
            if (currentBusiness?.deliverySettings?.zones) {
                let zoneFound = false;
                for (const zone of currentBusiness.deliverySettings.zones) {
                    if (addressLower.includes(zone.city.toLowerCase())) {
                        deliveryCharge = zone.charge || 150;
                        deliveryTime = zone.time || '1-2 days';
                        detectedZone = zone.city;
                        zoneFound = true;
                        break;
                    }
                }
                
                if (!zoneFound) {
                    deliveryCharge = currentBusiness.deliverySettings?.default?.otherCities?.charge || 300;
                    deliveryTime = currentBusiness.deliverySettings?.default?.otherCities?.time || '3-5 days';
                    detectedZone = 'Other City';
                }
            } else {
                // Default detection
                if (addressLower.includes('karachi') || addressLower.includes('lahore') || addressLower.includes('islamabad')) {
                    deliveryCharge = 150;
                    deliveryTime = '1-2 days';
                    detectedZone = 'Metro City';
                } else {
                    deliveryCharge = 300;
                    deliveryTime = '3-5 days';
                    detectedZone = 'Other City';
                }
            }
            
            // Check for free delivery
            const subtotal = cart.reduce((sum, item) => {
                const price = item.discountPrice || item.originalPrice || 0;
                return sum + (price * item.quantity);
            }, 0);
            
            if (currentBusiness?.deliverySettings?.freeDeliveryMin && subtotal >= currentBusiness.deliverySettings.freeDeliveryMin) {
                deliveryCharge = 0;
                deliveryTime += ' (Free)';
            }
            
            updateDeliveryUI();
        }

        function updateDeliveryUI() {
            const zoneEl = document.getElementById('deliveryZone');
            const timeEl = document.getElementById('deliveryTime');
            const deliveryEl = document.getElementById('summaryDelivery');
            const totalEl = document.getElementById('summaryTotal');
            
            if (zoneEl) zoneEl.textContent = detectedZone || 'Not calculated';
            if (timeEl) timeEl.textContent = deliveryTime || 'Enter address';
            if (deliveryEl) deliveryEl.textContent = `PKR ${deliveryCharge.toFixed(2)}`;
            
            if (totalEl) {
                const subtotal = cart.reduce((sum, item) => {
                    const price = item.discountPrice || item.originalPrice || 0;
                    return sum + (price * item.quantity);
                }, 0);
                totalEl.textContent = `PKR ${(subtotal + deliveryCharge).toFixed(2)}`;
            }
        }

        // ========== TOKEN GENERATION ==========
        function generateToken() {
            const prefix = currentBusiness?.tokenSystem?.prefix || 'TKT';
            const timestamp = Date.now().toString().slice(-8);
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let random = '';
            for (let i = 0; i < 4; i++) {
                random += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `${prefix}-${timestamp}-${random}`;
        }

        // ========== PLACE ORDER ==========
        async function placeOrder() {
            const phone = document.getElementById('checkoutPhone').value;
            const address = document.getElementById('checkoutAddress').value;
            
            if (!phone || !address) {
                showNotification('âŒ Please fill all fields');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('âŒ Your cart is empty');
                return;
            }
            
            // Save customer info
            customerInfo.phone = phone;
            customerInfo.address = address;
            localStorage.setItem('customerPhone', phone);
            localStorage.setItem('customerAddress', address);
            
            const token = generateToken();
            const orderId = 'ORD-' + Date.now().toString().slice(-8);
            
            const subtotal = cart.reduce((sum, item) => {
                const price = item.discountPrice || item.originalPrice || 0;
                return sum + (price * item.quantity);
            }, 0);
            
            const total = subtotal + deliveryCharge;
            
            const orderData = {
                business_id: currentBusiness.id,
                order_id: orderId,
                token: token,
                customer_name: customerInfo.name || 'Customer',
                customer_phone: phone,
                customer_address: address,
                items: cart.map(item => ({
                    title: item.title,
                    price: item.discountPrice || item.originalPrice || 0,
                    quantity: item.quantity,
                    image: item.image || ''
                })),
                subtotal: subtotal,
                delivery_charge: deliveryCharge,
                total: total,
                payment_method: selectedPaymentMethod === 'cod' ? 'Cash on Delivery' : selectedPaymentMethod,
                status: 'confirmed',
                zone: detectedZone,
                estimated_delivery: deliveryTime,
                created_at: new Date().toISOString()
            };
            
            try {
                // Save to Supabase
                const { error } = await supabase
                    .from('orders')
                    .insert([orderData]);
                
                if (error) throw error;
                
                // Clear cart
                cart = [];
                saveCart();
                updateCartUI();
                closeCheckout();
                
                // Show confirmation
                showOrderConfirmation(orderData);
                
                // Send WhatsApp notification if number exists
                if (currentBusiness?.payments?.whatsapp?.number) {
                    sendWhatsAppNotification(orderData);
                }
                
            } catch (error) {
                console.error('Error placing order:', error);
                showNotification('âŒ Error placing order');
            }
        }

        function showOrderConfirmation(orderData) {
            const orderContent = document.getElementById('orderContent');
            
            orderContent.innerHTML = `
                <div class="order-ticket">
                    <div class="ticket-header">
                        <span style="font-weight:700;">Order Confirmed! ðŸŽ‰</span>
                        <span class="ticket-status">${orderData.status}</span>
                    </div>
                    
                    <div class="token-display">
                        <div style="font-size:14px; opacity:0.9;">Your Order Token</div>
                        <div class="token-code">${orderData.token}</div>
                        <div style="font-size:12px; margin-top:10px;">Use this to track your order</div>
                    </div>
                    
                    <div style="margin:20px 0;">
                        <div style="margin-bottom:10px;">
                            <span style="color:#64748b;">Order ID:</span>
                            <span style="font-weight:700; float:right;">${orderData.order_id}</span>
                        </div>
                        <div style="margin-bottom:10px;">
                            <span style="color:#64748b;">Phone:</span>
                            <span style="font-weight:700; float:right;">${orderData.customer_phone}</span>
                        </div>
                        <div style="margin-bottom:10px;">
                            <span style="color:#64748b;">Address:</span>
                            <span style="font-weight:700; float:right; max-width:200px;">${orderData.customer_address}</span>
                        </div>
                        <div style="margin-bottom:10px;">
                            <span style="color:#64748b;">Delivery:</span>
                            <span style="font-weight:700; float:right;">${orderData.estimated_delivery}</span>
                        </div>
                    </div>
                    
                    <div style="border-top:1px dashed #e2e8f0; border-bottom:1px dashed #e2e8f0; padding:15px 0; margin:15px 0;">
                        ${orderData.items.map(item => `
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span>${item.title} x${item.quantity}</span>
                                <span style="font-weight:700;">PKR ${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin:15px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span>Subtotal</span>
                            <span>PKR ${orderData.subtotal.toFixed(2)}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span>Delivery</span>
                            <span>PKR ${orderData.delivery_charge.toFixed(2)}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:800; margin-top:10px; padding-top:10px; border-top:2px solid #e2e8f0;">
                            <span>Total</span>
                            <span style="color:#10b981;">PKR ${orderData.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="downloadTicket('${orderData.token}')" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
                            <i class="fas fa-download"></i> Save
                        </button>
                        <button onclick="shareTicket('${orderData.token}')" style="flex:1; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                    
                    <button onclick="window.location.href='tracking.html?token=${orderData.token}'" style="width:100%; padding:12px; background:linear-gradient(135deg, #25D366 0%, #128C7E 100%); color:white; border:none; border-radius:10px; font-weight:600; margin-top:10px; cursor:pointer;">
                        <i class="fas fa-truck"></i> Track Order
                    </button>
                </div>
            `;
            
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // ========== WHATSAPP NOTIFICATION ==========
        function sendWhatsAppNotification(orderData) {
            const whatsappNumber = currentBusiness?.payments?.whatsapp?.number;
            if (!whatsappNumber) return;
            
            const message = `ðŸ›ï¸ *NEW ORDER CONFIRMED*\n\n` +
                `*Token:* ${orderData.token}\n` +
                `*Order ID:* ${orderData.order_id}\n` +
                `*Customer:* ${orderData.customer_phone}\n` +
                `*Address:* ${orderData.customer_address}\n` +
                `*Total:* PKR ${orderData.total}\n` +
                `*Payment:* ${orderData.payment_method}\n` +
                `*Items:* ${orderData.items.length}`;
            
            const phone = whatsappNumber.replace(/\D/g, '');
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // ========== TICKET FUNCTIONS ==========
        function downloadTicket(token) {
            const ticketText = `Order Ticket: ${token}\nBusiness: ${currentBusiness?.businessName || 'Business'}\nDate: ${new Date().toLocaleString()}`;
            const blob = new Blob([ticketText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order-${token}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareTicket(token) {
            if (navigator.share) {
                navigator.share({
                    title: 'Order Ticket',
                    text: `Order Token: ${token}`
                });
            } else {
                navigator.clipboard.writeText(`Order Token: ${token}`);
                showNotification('Token copied to clipboard');
            }
        }

        // ========== ADDRESS PROMPT ==========
        function showAddressPrompt() {
            const phone = prompt('Enter your phone number:');
            if (phone) {
                customerInfo.phone = phone;
                localStorage.setItem('customerPhone', phone);
                
                const address = prompt('Enter your delivery address:');
                if (address) {
                    customerInfo.address = address;
                    localStorage.setItem('customerAddress', address);
                    openCheckout();
                }
            }
        }

        // ========== REAL-TIME SUBSCRIPTIONS ==========
        function subscribeToOrders() {
            if (!currentBusiness) return;
            
            supabase
                .channel('orders-channel')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'orders',
                    filter: `business_id=eq.${currentBusiness.id}`
                }, payload => {
                    showNotification('ðŸ†• New order received!');
                    updateTrackingBadge();
                })
                .subscribe();
        }

        async function updateTrackingBadge() {
            if (!currentBusiness || !customerInfo.phone) return;
            
            const { data } = await supabase
                .from('orders')
                .select('*')
                .eq('customer_phone', customerInfo.phone)
                .eq('business_id', currentBusiness.id)
                .in('status', ['confirmed', 'processing', 'shipped']);
            
            const badge = document.getElementById('trackingBadge');
            if (data && data.length > 0) {
                badge.textContent = data.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ========== NOTIFICATIONS ==========
        let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
        let unreadCount = notifications.filter(n => !n.read).length;

        function toggleNotifications() {
            // Implement notification drawer
            showNotification('Notifications feature coming soon');
        }

        function addNotification(title, message) {
            const notification = {
                id: Date.now(),
                title,
                message,
                time: new Date(),
                read: false
            };
            
            notifications.unshift(notification);
            unreadCount++;
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            const badge = document.getElementById('notificationBadge');
            badge.textContent = unreadCount;
            badge.style.display = 'flex';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ========== NAVIGATION ==========
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            event.currentTarget.classList.add('active');
            
            switch(page) {
                case 'home':
                    window.location.href = `app.html?id=${currentBusiness?.id}`;
                    break;
                case 'orders':
                    window.location.href = `tracking.html?id=${currentBusiness?.id}`;
                    break;
                case 'profile':
                    showAddressPrompt();
                    break;
            }
        }

        // ========== SEARCH ==========
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = products.filter(p => 
                p.title?.toLowerCase().includes(searchTerm) ||
                p.desc?.toLowerCase().includes(searchTerm)
            );
            showProducts(filtered);
        });

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadBusiness();
            
            // Update business status every minute
            setInterval(updateBusinessStatus, 60000);
            
            // Check for active orders
            setInterval(updateTrackingBadge, 30000);
        });
    </script>
</body>
</html>
