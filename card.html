<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop</title>
    <meta name="theme-color" content="#0f172a">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #0f172a;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.05);
        }

        /* Header */
        .header {
            background: #0f172a;
            padding: 20px;
            color: white;
        }

        .business {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .business img {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            object-fit: cover;
            background: #334155;
        }

        .business h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .business p {
            font-size: 13px;
            opacity: 0.8;
        }

        /* Search */
        .search {
            background: #1e293b;
            margin: 20px;
            padding: 12px 20px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search i {
            color: #94a3b8;
        }

        .search input {
            background: none;
            border: none;
            color: white;
            width: 100%;
            font-size: 15px;
            outline: none;
        }

        .search input::placeholder {
            color: #64748b;
        }

        /* Categories */
        .categories {
            padding: 0 20px;
            margin-bottom: 30px;
        }

        .categories h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .cat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .cat-item {
            text-align: center;
        }

        .cat-icon {
            width: 65px;
            height: 65px;
            background: #f1f5f9;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 24px;
            color: #0f172a;
            transition: 0.3s;
        }

        .cat-item span {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        /* Products */
        .products {
            padding: 0 20px 100px;
        }

        .products h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
            transition: 0.3s;
        }

        .product-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #f8fafc;
        }

        .product-info {
            padding: 12px;
        }

        .product-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #0f172a;
        }

        .product-price {
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 10px;
        }

        .product-price span {
            color: #64748b;
            font-size: 12px;
            font-weight: 400;
            text-decoration: line-through;
            margin-left: 8px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .btn-add {
            flex: 1;
            background: #0f172a;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-buy {
            width: 45px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            max-width: 480px;
            width: 100%;
            background: white;
            padding: 12px 20px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cart-icon {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-total {
            font-weight: 700;
            color: #0f172a;
        }

        .checkout-btn {
            background: #0f172a;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .close {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #475569;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            font-size: 15px;
            outline: none;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #0f172a;
        }

        /* Payment Methods */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .payment-card {
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
        }

        .payment-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .payment-card i {
            font-size: 24px;
            color: #0f172a;
            margin-bottom: 5px;
        }

        /* Order Ticket */
        .ticket {
            background: #0f172a;
            color: white;
            border-radius: 24px;
            padding: 25px;
            margin: 20px 0;
        }

        .ticket-token {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 2px;
            margin: 15px 0;
            color: #10b981;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            color: white;
            padding: 12px 25px;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="business" id="businessInfo">
                <img src="" id="businessLogo">
                <div>
                    <h1 id="businessName">Loading...</h1>
                    <p id="businessStatus">Open Now</p>
                </div>
            </div>

            <!-- Search -->
            <div class="search">
                <i class="fas fa-search"></i>
                <input type="text" id="search" placeholder="Search products...">
            </div>
        </div>

        <!-- Categories -->
        <div class="categories">
            <h2>Categories</h2>
            <div class="cat-grid" id="categories"></div>
        </div>

        <!-- Products -->
        <div class="products">
            <h2>Featured Products</h2>
            <div class="product-grid" id="products"></div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <div class="cart-info" onclick="openCart()">
                <div class="cart-icon">
                    <i class="fas fa-shopping-cart" style="font-size: 22px;"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <span class="cart-total" id="cartTotal">PKR 0</span>
            </div>
            <button class="checkout-btn" onclick="openCheckout()">Checkout</button>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Cart</h3>
                <div class="close" onclick="closeCart()">âœ•</div>
            </div>
            <div id="cartItems"></div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Checkout</h3>
                <div class="close" onclick="closeCheckout()">âœ•</div>
            </div>
            <div id="checkoutForm"></div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="paymentTitle">Payment</h3>
                <div class="close" onclick="closePayment()">âœ•</div>
            </div>
            <div id="paymentDetails"></div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order Confirmed! ðŸŽ‰</h3>
                <div class="close" onclick="closeOrder()">âœ•</div>
            </div>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = supabase.createClient(
            "https://dfvnefbxgayxqgjjgtrr.supabase.co",
            "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
        );

        // State
        let business = null;
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let customer = {
            phone: localStorage.getItem('phone') || '',
            address: localStorage.getItem('address') || ''
        };
        let deliveryCharge = 0;

        // Initialize
        (async () => {
            const params = new URLSearchParams(location.search);
            let id = params.get('id') || localStorage.getItem('bid');
            
            if (!id) {
                alert('No business ID');
                return;
            }

            // Check short ID
            if (id.length === 6) {
                const { data } = await supabase.from('short_urls').select('full_id').eq('short_id', id).single();
                if (data) id = data.full_id;
            }

            // Load business
            const { data } = await supabase.from('cards').select('*').eq('id', id).single();
            if (!data) return;

            business = JSON.parse(data.data);
            business.id = id;
            products = business.products || [];
            
            localStorage.setItem('bid', id);
            
            render();
            updateCart();
        })();

        // Render UI
        function render() {
            if (!business) return;

            // Header
            document.getElementById('businessName').textContent = business.businessName || business.name;
            document.getElementById('businessLogo').src = business.profileImage || 'https://via.placeholder.com/60';
            
            // Categories
            const cats = [...new Set(products.map(p => p.category || 'General'))].slice(0, 4);
            document.getElementById('categories').innerHTML = cats.map(c => `
                <div class="cat-item" onclick="filterByCategory('${c}')">
                    <div class="cat-icon"><i class="fas fa-tag"></i></div>
                    <span>${c}</span>
                </div>
            `).join('');

            // Products
            renderProducts(products.slice(0, 4));
        }

        function renderProducts(list) {
            document.getElementById('products').innerHTML = list.map((p, i) => `
                <div class="product-card">
                    <img src="${p.image || 'https://via.placeholder.com/200'}" class="product-img">
                    <div class="product-info">
                        <div class="product-title">${p.title}</div>
                        <div class="product-price">
                            PKR ${p.discountPrice || p.originalPrice}
                            ${p.originalPrice ? `<span>PKR ${p.originalPrice}</span>` : ''}
                        </div>
                        <div class="product-actions">
                            <button class="btn-add" onclick="addToCart(${i})">Add</button>
                            <button class="btn-buy" onclick="buyNow(${i})"><i class="fas fa-bolt"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Cart Functions
        function addToCart(index) {
            const item = { ...products[index], quantity: 1 };
            const existing = cart.find(x => x.title === item.title);
            if (existing) existing.quantity++;
            else cart.push(item);
            updateCart();
            toast('âœ… Added to cart');
        }

        function buyNow(index) {
            addToCart(index);
            openCheckout();
        }

        function updateCart() {
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            const total = cart.reduce((s, i) => s + (i.discountPrice || i.originalPrice) * i.quantity, 0);
            
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = `PKR ${total}`;
            
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        // Cart Modal
        function openCart() {
            const items = document.getElementById('cartItems');
            if (cart.length === 0) {
                items.innerHTML = '<p style="text-align:center; padding:40px;">Cart is empty</p>';
            } else {
                items.innerHTML = cart.map((item, i) => `
                    <div style="display:flex; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #f1f5f9;">
                        <img src="${item.image}" style="width:70px; height:70px; border-radius:12px; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:600;">${item.title}</div>
                            <div style="font-weight:700; color:#10b981; margin:5px 0;">PKR ${(item.discountPrice || item.originalPrice) * item.quantity}</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <button onclick="updateQty(${i}, -1)" style="width:30px; height:30px; background:#f1f5f9; border:none; border-radius:8px;">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateQty(${i}, 1)" style="width:30px; height:30px; background:#f1f5f9; border:none; border-radius:8px;">+</button>
                                <button onclick="removeItem(${i})" style="color:#ef4444; background:none; border:none;">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            document.getElementById('cartModal').classList.add('active');
        }

        function updateQty(index, delta) {
            cart[index].quantity += delta;
            if (cart[index].quantity < 1) cart.splice(index, 1);
            updateCart();
            openCart();
        }

        function removeItem(index) {
            cart.splice(index, 1);
            updateCart();
            openCart();
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }

        // Checkout
        function openCheckout() {
            if (cart.length === 0) {
                toast('Cart is empty');
                return;
            }

            const subtotal = cart.reduce((s, i) => s + (i.discountPrice || i.originalPrice) * i.quantity, 0);
            
            document.getElementById('checkoutForm').innerHTML = `
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="phone" value="${customer.phone}" placeholder="03XXXXXXXXX">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="address" placeholder="Delivery address">${customer.address}</textarea>
                </div>

                <div style="background:#f8fafc; border-radius:16px; padding:15px; margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>Subtotal</span>
                        <span>PKR ${subtotal}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>Delivery</span>
                        <span id="deliveryCharge">PKR 0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:800; margin-top:8px; padding-top:8px; border-top:2px solid #e2e8f0;">
                        <span>Total</span>
                        <span id="totalAmount">PKR ${subtotal}</span>
                    </div>
                </div>

                <h3 style="margin:20px 0 10px;">Payment Method</h3>
                <div class="payment-methods" id="paymentMethods"></div>

                <button onclick="placeOrder()" style="width:100%; padding:18px; background:#0f172a; color:white; border:none; border-radius:16px; font-weight:700; font-size:16px; margin-top:20px; cursor:pointer;">
                    Place Order
                </button>
            `;

            // Payment methods
            const methods = ['cod', 'jazzcash', 'easypaisa', 'bank'].filter(m => business?.payments?.gateways?.[m]?.active !== false);
            document.getElementById('paymentMethods').innerHTML = methods.map(m => `
                <div class="payment-card" onclick="selectPayment('${m}')" id="pay-${m}">
                    <i class="fas fa-${m === 'cod' ? 'truck' : m === 'jazzcash' ? 'mobile-alt' : m === 'easypaisa' ? 'wallet' : 'university'}"></i>
                    <span>${m === 'cod' ? 'Cash' : m}</span>
                </div>
            `).join('');

            if (methods.length) selectPayment(methods[0]);

            document.getElementById('checkoutModal').classList.add('active');
        }

        function selectPayment(method) {
            document.querySelectorAll('.payment-card').forEach(el => el.classList.remove('selected'));
            document.getElementById(`pay-${method}`)?.classList.add('selected');
            window.selectedPayment = method;
        }

        function closeCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        // Place Order
        async function placeOrder() {
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            if (!phone || !address) {
                toast('Please fill all fields');
                return;
            }

            // Save customer
            customer.phone = phone;
            customer.address = address;
            localStorage.setItem('phone', phone);
            localStorage.setItem('address', address);

            // Calculate
            const subtotal = cart.reduce((s, i) => s + (i.discountPrice || i.originalPrice) * i.quantity, 0);
            const total = subtotal + deliveryCharge;
            
            // Generate token
            const token = 'TKT-' + Date.now().toString().slice(-8) + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();

            // Order data
            const order = {
                business_id: business.id,
                order_id: 'ORD-' + Date.now().toString().slice(-8),
                token,
                customer_phone: phone,
                customer_address: address,
                items: cart,
                subtotal,
                delivery_charge: deliveryCharge,
                total,
                payment_method: window.selectedPayment || 'cod',
                status: 'confirmed',
                created_at: new Date().toISOString()
            };

            // Save to Supabase
            const { error } = await supabase.from('orders').insert([order]);
            
            if (error) {
                toast('Error placing order');
                return;
            }

            // Clear cart
            cart = [];
            updateCart();
            closeCheckout();

            // Show confirmation
            document.getElementById('orderDetails').innerHTML = `
                <div class="ticket">
                    <div style="text-align:center;">
                        <i class="fas fa-check-circle" style="font-size:50px; color:#10b981; margin-bottom:15px;"></i>
                        <h2 style="margin-bottom:10px;">Order Confirmed!</h2>
                        <div class="ticket-token">${token}</div>
                        <p style="margin:20px 0;">Total: PKR ${total}</p>
                        <button onclick="window.location.href='track.html?token=${token}'" style="background:white; color:#0f172a; border:none; padding:12px 30px; border-radius:40px; font-weight:700; cursor:pointer;">
                            Track Order
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrder() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // Payment Modal
        function showPayment(method) {
            const gateways = business?.payments?.gateways;
            const data = gateways?.[method];
            
            document.getElementById('paymentTitle').textContent = method.toUpperCase();
            document.getElementById('paymentDetails').innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <i class="fas fa-${method === 'jazzcash' ? 'mobile-alt' : method === 'bank' ? 'university' : 'credit-card'}" style="font-size:50px; color:#0f172a; margin-bottom:20px;"></i>
                    <p style="margin:20px 0;">Send payment to:</p>
                    <div style="font-size:24px; font-weight:800; color:#10b981;">${data?.number || '03001234567'}</div>
                    <button onclick="closePayment()" style="width:100%; padding:15px; background:#0f172a; color:white; border:none; border-radius:12px; margin-top:20px; cursor:pointer;">
                        I've Paid
                    </button>
                </div>
            `;
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePayment() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        // Search
        document.getElementById('search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = products.filter(p => p.title?.toLowerCase().includes(term));
            renderProducts(filtered);
        });

        function filterByCategory(cat) {
            const filtered = products.filter(p => (p.category || 'General') === cat);
            renderProducts(filtered);
        }

        // Toast
        function toast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }
    </script>
</body>
</html>
