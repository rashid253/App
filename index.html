<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="dynamicTitle">Digital Business</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Premium Digital Business App">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">
<link rel="manifest" href="manifest.json" id="manifestLink">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* ===== ALL EXISTING STYLES - KEEP AS BEFORE ===== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --whatsapp-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --dark-color: #0f172a;
  --darker-color: #020617;
  --light-color: #f8fafc;
  --lighter-color: #ffffff;
  --glass-bg: rgba(255, 255, 255, 0.98);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
  --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
  --border-radius-xl: 32px;
  --border-radius-lg: 24px;
  --border-radius-md: 16px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--primary-gradient);
  min-height: 100vh;
  color: var(--dark-color);
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: none;
}

.app-container {
  position: relative;
  width: 100%;
  height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  background: var(--light-color);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border-radius: 0;
}

.page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--light-color);
  transform: translateX(100%);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition-slow);
  z-index: 1;
}

.page.active {
  transform: translateX(0);
  opacity: 1;
  visibility: visible;
  z-index: 2;
}

.page.slide-out {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}

#loadingScreen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: var(--primary-gradient);
  z-index: 100;
}

.loader {
  width: 80px;
  height: 80px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 30px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 70px;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  border-radius: var(--border-radius-md);
  cursor: pointer;
  transition: var(--transition);
  flex: 1;
  position: relative;
}

.nav-item.active {
  background: rgba(102, 126, 234, 0.1);
}

.nav-icon {
  font-size: 22px;
  color: #64748b;
  transition: var(--transition);
  position: relative;
}

.nav-item.active .nav-icon {
  color: #667eea;
  transform: scale(1.1);
}

.nav-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  transition: var(--transition);
}

.nav-item.active .nav-label {
  color: #667eea;
  font-weight: 700;
}

/* Cart Badge - Bottom Navigation - FIXED POSITION */
.cart-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  font-size: 11px;
  font-weight: 900;
  min-width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  padding: 0 4px;
  z-index: 1001;
}

/* ===== FIXED HEADER ===== */
.header-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 80px;
  background: rgba(102, 126, 234, 0.95);
  backdrop-filter: blur(30px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 1001;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.header-back-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 16px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.save-contact-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 76px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.header-icons {
  position: absolute;
  top: 18px;
  right: 16px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 12px;
  z-index: 9998;
}

.header-icon-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.delivery-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #10b981;
  color: white;
  font-size: 10px;
  font-weight: 900;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.5);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 11;
}

/* ===== NOTIFICATION DRAWER ===== */
.notification-drawer {
  position: fixed;
  top: 0;
  right: -350px;
  width: 320px;
  height: 100%;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-left: 1px solid var(--glass-border);
  box-shadow: -10px 0 40px rgba(0,0,0,0.2);
  z-index: 2000;
  transition: var(--transition-slow);
  display: flex;
  flex-direction: column;
}

.notification-drawer.open {
  right: 0;
}

/* ===== PRODUCT CARDS ===== */
.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  padding: 0 12px;
  align-items: stretch;
  margin-bottom: 20px;
}

.product-card {
  height: 280px;
  width: 100%;
  display: flex;
  flex-direction: column;
  background: var(--lighter-color);
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  padding: 10px;
  overflow: hidden;
  transition: var(--transition-fast);
  cursor: pointer;
  position: relative;
  min-height: 280px;
  max-height: 280px;
}

.product-image-container {
  position: relative;
  width: 100%;
  height: 160px;
  background: #f8fafc;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 8px;
  flex-shrink: 0;
  border: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.product-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  display: block;
  padding: 4px;
}

/* ===== BADGE POSITIONS ===== */
.badge-container {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 15;
}

.discount-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(239, 68, 68, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 800;
  box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.offer-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(16, 185, 129, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 12px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.feature-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(139, 92, 246, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.product-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  padding: 0 2px;
  position: relative;
}

.product-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--dark-color);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  height: 34px;
  margin-bottom: 6px;
}

.price-badge-container {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  height: 24px;
}

.current-price {
  font-weight: 900;
  color: #10b981;
  font-size: 15px;
  background: rgba(16, 185, 129, 0.1);
  padding: 4px 10px;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
}

.original-price {
  text-decoration: line-through;
  color: #94a3b8;
  font-size: 11px;
  font-weight: 500;
  margin-left: 8px;
}

.product-actions {
  display: flex;
  gap: 8px;
  height: 32px;
  margin-top: auto;
}

.btn-primary, .btn-secondary {
  flex: 1;
  height: 32px;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: var(--transition-fast);
  white-space: nowrap;
  padding: 0 8px;
}

.btn-primary {
  background: var(--success-gradient);
  color: white;
}

.btn-secondary {
  background: var(--info-gradient);
  color: white;
}

/* ===== IMAGE ZOOM OVERLAY ===== */
.image-zoom-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.image-zoom-content {
  max-width: 90%;
  max-height: 90%;
  animation: zoomIn 0.3s ease;
}

/* ===== EXIT MODAL ===== */
.exit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  padding: 20px;
}

/* ===== INSTALL BUTTON ===== */
.install-button-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  animation: slideDown 0.5s ease;
}

.install-btn {
  padding: 12px 24px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== ORDER MANAGEMENT ===== */
.order-card {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 16px;
  margin: 12px 16px;
  box-shadow: var(--shadow-md);
  border: 1px solid #e2e8f0;
  border-left: 5px solid #667eea;
}

/* ===== ADDRESS AUTO-DETECT ===== */
.address-auto-detect {
  background: var(--light-color);
  border-radius: var(--border-radius-md);
  padding: 16px;
  margin: 16px 0;
  border: 2px dashed #667eea;
}

.delivery-charge-calculator {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: var(--border-radius-md);
  padding: 20px;
  margin: 16px 0;
  border: 1px solid #e2e8f0;
}

/* ===== PROFESSIONAL PAYMENT METHODS ===== */
.pro-payment-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 16px 0;
}

.pro-payment-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: var(--border-radius-md);
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pro-payment-card.selected {
  border-color: #10b981;
  background: #f0fdf4;
  transform: scale(1.02);
}

.pro-payment-card.has-proof {
  border-color: #667eea;
  background: #eef2ff;
}

.pro-payment-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

/* ===== ORDER TICKET ===== */
.order-ticket {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: var(--border-radius-lg);
  padding: 24px;
  margin: 20px 0;
  color: white;
  position: relative;
  overflow: hidden;
}

.ticket-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  border-bottom: 1px dashed rgba(255,255,255,0.3);
  padding-bottom: 12px;
}

.ticket-id {
  font-size: 18px;
  font-weight: 900;
  letter-spacing: 1px;
}

.ticket-date {
  font-size: 12px;
  opacity: 0.9;
}

.ticket-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.ticket-total {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
  font-size: 18px;
  font-weight: 800;
}

/* ===== TOKEN MANAGEMENT ===== */
.token-management {
  background: white;
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 16px;
  box-shadow: var(--shadow-md);
}

.token-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.token-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.token-list {
  max-height: 400px;
  overflow-y: auto;
}

.token-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
  cursor: pointer;
  transition: background 0.2s;
}

.token-item:hover {
  background: #f8fafc;
}

.token-code {
  font-weight: 800;
  color: #667eea;
  font-size: 14px;
}

.token-amount {
  font-weight: 700;
  color: #10b981;
  font-size: 14px;
}

.token-status {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  text-transform: capitalize;
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--glass-bg);
  border-radius: var(--border-radius-xl);
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--glass-border);
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0,0,0,0.1);
  color: var(--dark-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
}

/* ===== PRODUCT MODAL ===== */
.product-modal-image-container {
  position: relative;
  width: 100%;
  min-height: 200px;
  max-height: 300px;
  background: #f8fafc;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #f1f5f9;
}

.product-modal-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 280px;
  object-fit: contain;
  display: block;
  padding: 8px;
}

.modal-price-container {
  margin-bottom: 16px;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}

/* ===== CUSTOMER INFO FORM ===== */
.customer-form {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: #475569;
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 15px;
  transition: all 0.3s;
}

.form-input:focus {
  border-color: #667eea;
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input.error {
  border-color: #ef4444;
}

.error-message {
  color: #ef4444;
  font-size: 11px;
  margin-top: 4px;
  display: none;
}

.pinpoint-location {
  background: #f8fafc;
  border: 2px dashed #94a3b8;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.pinpoint-location:hover {
  border-color: #667eea;
  background: #eef2ff;
}

.pinpoint-icon {
  width: 40px;
  height: 40px;
  background: #667eea;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
}

.pinpoint-text {
  flex: 1;
}

.pinpoint-title {
  font-weight: 700;
  color: #1e293b;
  font-size: 14px;
}

.pinpoint-subtitle {
  font-size: 11px;
  color: #64748b;
}

.location-coordinates {
  font-size: 10px;
  color: #94a3b8;
  margin-top: 4px;
}

/* ===== NOTIFICATION ALERT ===== */
.notification-alert {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--whatsapp-gradient);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  z-index: 3000;
  max-width: 300px;
  animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  display: none;
}

/* ===== PAGE HEADERS ===== */
#homePage, #productsPage, #cartPage, #aboutPage, #contactPage, #deliveryPage, #adminPage, #loginPage, #customerInfoPage, #paymentPage {
  padding-top: 80px;
  padding-bottom: 100px;
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
}

.app-header {
  background: var(--primary-gradient);
  padding: 30px 25px;
  border-radius: 0 0 50px 50px;
  margin: 0;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  gap: 12px;
  margin-top: 30px;
}

.action-card {
  background: rgba(255,255,255,0.2);
  padding: 12px;
  border-radius: 16px;
  text-align: center;
  color: white;
  cursor: pointer;
}

/* ===== NEW STYLES ===== */
.product-zoom-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.98);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  backdrop-filter: blur(20px);
  cursor: pointer;
}

.product-zoom-content {
  max-width: 90%;
  max-height: 90vh;
  object-fit: contain;
  animation: zoomIn 0.3s ease;
}

.payment-proof-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 6000;
  padding: 20px;
}

.popup-content {
  background: white;
  border-radius: 32px;
  width: 100%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 24px;
  animation: slideUp 0.4s ease;
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.popup-header h3 {
  font-size: 22px;
  font-weight: 800;
  color: var(--dark-color);
}

.popup-close {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: #f1f5f9;
  border: none;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
}

.popup-close:hover {
  background: #e2e8f0;
}

.payment-instructions {
  background: #f0f9ff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 20px;
  border-left: 4px solid #3b82f6;
}

.payment-instructions p {
  margin: 8px 0;
  font-size: 14px;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

.payment-instructions i {
  color: #3b82f6;
  width: 20px;
}

.popup-upload-area {
  border: 3px dashed #e2e8f0;
  border-radius: 20px;
  padding: 30px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  margin: 20px 0;
  background: #f8fafc;
}

.popup-upload-area:hover {
  border-color: #10b981;
  background: #f0fdf4;
}

.popup-upload-area i {
  font-size: 48px;
  color: #94a3b8;
  margin-bottom: 12px;
}

.popup-upload-area.has-file {
  border-color: #10b981;
  background: #f0fdf4;
}

.popup-upload-area.has-file i {
  color: #10b981;
}

.popup-preview {
  max-width: 200px;
  max-height: 200px;
  margin: 0 auto 20px;
  border-radius: 16px;
  border: 3px solid #e2e8f0;
  display: none;
}

.popup-preview.show {
  display: block;
}

.popup-buttons {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.popup-btn {
  flex: 1;
  padding: 16px;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
}

.popup-btn-primary {
  background: var(--success-gradient);
  color: white;
}

.popup-btn-secondary {
  background: #f1f5f9;
  color: #475569;
}

.popup-btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.address-display-container {
  width: 100%;
}

.address-display {
  background: white;
  border-radius: 16px;
  padding: 16px;
  margin: 8px 0;
  border: 2px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.address-text {
  flex: 1;
  font-size: 14px;
  color: #1e293b;
  line-height: 1.5;
}

.address-edit-btn {
  background: none;
  border: none;
  color: #667eea;
  font-size: 20px;
  cursor: pointer;
  padding: 8px;
  margin-left: 8px;
}

.address-edit-btn:hover {
  color: #5a67d8;
}

.address-edit-mode {
  background: #f8fafc;
  border-radius: 16px;
  padding: 16px;
  margin: 8px 0;
  border: 2px solid #e2e8f0;
}

.receipt-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 7000;
  padding: 20px;
}

.receipt-content {
  background: white;
  border-radius: 32px;
  width: 100%;
  max-width: 380px;
  padding: 24px;
  animation: slideUp 0.4s ease;
}

.receipt-header {
  text-align: center;
  margin-bottom: 24px;
}

.receipt-header i {
  font-size: 60px;
  color: #10b981;
  margin-bottom: 12px;
}

.receipt-header h2 {
  font-size: 24px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.receipt-header p {
  color: #64748b;
  font-size: 14px;
}

.receipt-details {
  background: #f8fafc;
  border-radius: 20px;
  padding: 20px;
  margin: 20px 0;
}

.receipt-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px dashed #e2e8f0;
}

.receipt-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.receipt-label {
  color: #64748b;
  font-size: 14px;
}

.receipt-value {
  font-weight: 700;
  color: var(--dark-color);
  font-size: 14px;
}

.receipt-total {
  font-size: 18px;
  font-weight: 900;
  color: #10b981;
}

.receipt-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.receipt-btn {
  flex: 1;
  padding: 16px;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
}

.receipt-btn-whatsapp {
  background: #25D366;
  color: white;
}

.receipt-btn-email {
  background: #f1f5f9;
  color: #475569;
}

.receipt-btn-download {
  background: var(--primary-gradient);
  color: white;
}

.receipt-btn-image {
  background: #8b5cf6;
  color: white;
}

.receipt-btn-track {
  background: #10b981;
  color: white;
}

.admin-confirm-btn {
  background: var(--success-gradient);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 30px;
  font-weight: 700;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
  width: 100%;
  justify-content: center;
  font-size: 16px;
}

.admin-quick-actions {
  display: flex;
  gap: 12px;
  padding: 16px;
  margin-bottom: 8px;
}

.admin-quick-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
  background: white;
  box-shadow: var(--shadow-sm);
  color: var(--dark-color);
}

.admin-quick-btn i {
  color: #667eea;
  font-size: 18px;
}

.admin-quick-btn:hover {
  background: #f8fafc;
  transform: translateY(-2px);
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 30px;
  font-size: 12px;
  font-weight: 700;
}

.status-pending { background: #fef3c7; color: #92400e; }
.status-confirmed { background: #dbeafe; color: #1e40af; }
.status-processing { background: #ede9fe; color: #5b21b6; }
.status-shipped { background: #d1fae5; color: #065f46; }
.status-delivered { background: #10b981; color: white; }
.status-cancelled { background: #fee2e2; color: #b91c1c; }
.status-refused { background: #e2e8f0; color: #475569; }

/* Payment Method Cards */
.jazzcash-card, .easypaisa-card, .bank-card, .cod-card {
  background: linear-gradient(135deg, #667eea10, #764ba210);
  border: 2px solid #667eea30;
  border-radius: 16px;
  padding: 16px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.3s;
}

.jazzcash-card:hover, .easypaisa-card:hover {
  transform: scale(1.02);
  border-color: #667eea;
}

.jazzcash-header, .easypaisa-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.jazzcash-header i, .easypaisa-header i {
  font-size: 32px;
  color: #667eea;
}

.qr-preview {
  width: 100px;
  height: 100px;
  margin: 10px auto;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
}

.toggle-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 15px 0;
  padding: 10px;
  background: #f8fafc;
  border-radius: 30px;
}

/* FIXED: Truck icon */
.truck-icon-fixed {
  cursor: pointer;
  transition: all 0.3s;
  color: white;
}

.truck-icon-fixed:hover {
  transform: scale(1.1);
  color: #10b981;
}

/* Auto-notification toggle */
.auto-notify-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: #f8fafc;
  border-radius: 30px;
  margin: 15px 0;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@media (max-width: 480px) {
  .app-container { max-width: 100%; }
  .pro-payment-grid { grid-template-columns: 1fr; }
  .token-stats { grid-template-columns: 1fr; }
  .quick-actions { grid-template-columns: repeat(2,1fr); }
  .notification-drawer { width: 100%; right: -100%; }
  .popup-content, .receipt-content { max-width: 100%; margin: 0 16px; }
  .admin-quick-actions { flex-direction: column; }
}
</style>
</head>

<body>
<div class="app-container">
  <!-- ===== FIXED HEADER ===== -->
  <div class="header-container">
    <button class="header-back-btn" id="headerBackBtn" onclick="window.goBack()" style="display:none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <button class="save-contact-btn" onclick="window.saveBusinessToContacts()" title="Save to Contacts">
      <i class="fas fa-address-card"></i>
    </button>
    
    <div class="header-icons">
      <div class="header-icon-btn" onclick="window.toggleNotificationDrawer()" title="Notifications">
        <i class="fas fa-bell" id="notificationBell"></i>
        <div class="delivery-badge" id="notificationBadge" style="display:none;">!</div>
      </div>
      
      <div class="header-icon-btn truck-icon-fixed" id="deliveryStatusBtn" onclick="window.checkDeliveryStatus()" title="Delivery Status">
        <i class="fas fa-truck" id="deliveryIcon"></i>
        <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
      </div>
      
      <div class="header-icon-btn" id="loginBtn" onclick="window.toggleLogin()" title="Login/Logout">
        <i class="fas fa-sign-in-alt" id="loginIcon"></i>
      </div>
      
      <div class="header-icon-btn" onclick="window.shareBusiness()" title="Share Business">
        <i class="fas fa-share-alt"></i>
      </div>
    </div>
  </div>

  <!-- ===== NOTIFICATION DRAWER ===== -->
  <div class="notification-drawer" id="notificationDrawer">
    <div class="notification-header" style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e2e8f0;">
      <h3><i class="fas fa-bell"></i> Notifications <span class="notification-count" id="notificationCount">0</span></h3>
      <button onclick="window.toggleNotificationDrawer()" style="background: none; border: none; font-size: 24px; color: var(--dark-color); cursor: pointer;">×</button>
    </div>
    <div class="notification-content" id="notificationList" style="flex:1; overflow-y:auto; padding:16px;"></div>
    <div class="notification-actions" style="padding:16px; display:flex; gap:12px; border-top:1px solid #e2e8f0;">
      <button onclick="window.markAllNotificationsAsRead()" style="flex:1; padding:10px; background: #f1f5f9; border: none; border-radius: 8px; font-weight: 700; color: #64748b; cursor: pointer;">
        Mark All Read
      </button>
      <button onclick="window.enableNotifications()" style="flex:1; padding:10px; background: var(--primary-gradient); border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer;">
        Enable Alerts
      </button>
    </div>
  </div>

  <!-- ===== IMAGE ZOOM OVERLAY ===== -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="window.closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- ===== PRODUCT ZOOM OVERLAY ===== -->
  <div class="product-zoom-overlay" id="productZoomOverlay" onclick="closeProductZoom()">
    <img src="" class="product-zoom-content" id="zoomedProductImage">
  </div>

  <!-- ===== PAYMENT PROOF POPUP ===== -->
  <div class="payment-proof-popup" id="paymentProofPopup">
    <div class="popup-content" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3><i class="fas fa-receipt" style="color:#10b981;"></i> Payment Confirmation</h3>
        <button class="popup-close" onclick="closePaymentProofPopup()">×</button>
      </div>
      
      <div class="payment-instructions" id="paymentInstructions">
        <!-- Dynamic instructions -->
      </div>
      
      <!-- QR/Barcode Preview (will be shown inside popup) -->
      <div id="barcodePreviewContainer" style="text-align:center; margin:15px 0; display:none;">
        <img id="barcodePreviewImage" src="" style="max-width:200px; max-height:200px; border-radius:16px; border:3px solid #667eea; padding:10px; background:white;">
        <p style="font-size:12px; color:#64748b; margin-top:5px;">Scan this QR code to pay</p>
      </div>
      
      <div style="margin: 10px 0; text-align: center;">
        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="skipProofCheckbox" onchange="toggleProofUpload()"> 
          <span style="font-size: 14px; color: var(--dark-color);">I don't have screenshot (send only transaction details)</span>
        </label>
      </div>
      
      <div id="proofUploadSection">
        <div class="popup-upload-area" id="popupUploadArea" onclick="document.getElementById('popupProofInput').click()">
          <i class="fas fa-cloud-upload-alt"></i>
          <div style="font-weight:600; margin-bottom:4px;">Upload payment screenshot (optional)</div>
          <div style="font-size:12px; color:#94a3b8;">PNG, JPG up to 5MB</div>
          <input type="file" id="popupProofInput" accept="image/*" style="display:none;" onchange="handlePopupProofUpload(this)">
        </div>
        
        <img id="popupProofPreview" class="popup-preview" src="" alt="Preview">
      </div>
      
      <div class="popup-buttons">
        <button class="popup-btn popup-btn-secondary" onclick="closePaymentProofPopup()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="popup-btn popup-btn-primary" id="confirmPaymentBtn" onclick="confirmPaymentWithProof()">
          <i class="fas fa-check"></i> Confirm & Send
        </button>
      </div>
    </div>
  </div>

  <!-- ===== RECEIPT MODAL ===== -->
  <div class="receipt-modal" id="receiptModal">
    <div class="receipt-content" onclick="event.stopPropagation()">
      <div class="receipt-header">
        <i class="fas fa-check-circle"></i>
        <h2>Order Confirmed!</h2>
        <p>Your receipt is ready</p>
      </div>
      
      <div class="receipt-details" id="receiptDetails">
        <!-- Receipt content -->
      </div>
      
      <div class="receipt-actions">
        <button class="receipt-btn receipt-btn-whatsapp" onclick="sendReceiptToWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
        <button class="receipt-btn receipt-btn-email" onclick="sendReceiptToEmail()">
          <i class="fas fa-envelope"></i> Email
        </button>
        <button class="receipt-btn receipt-btn-download" onclick="downloadReceipt()">
          <i class="fas fa-download"></i> Text
        </button>
        <button class="receipt-btn receipt-btn-image" onclick="downloadReceiptAsImage()">
          <i class="fas fa-image"></i> Image
        </button>
        <button class="receipt-btn receipt-btn-track" onclick="window.navigateTo('deliveryPage')">
          <i class="fas fa-truck"></i> Track
        </button>
      </div>
      
      <button class="receipt-btn" style="width:100%; margin-top:12px; background:var(--primary-gradient); color:white;" onclick="closeReceiptModal()">
        <i class="fas fa-check"></i> Done
      </button>
    </div>
  </div>

  <!-- ===== EXIT MODAL ===== -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal" style="background:white; max-width:340px; padding:24px; border-radius:24px;">
      <h2 style="margin-bottom:12px;"><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p style="margin-bottom:16px; color:#64748b;">Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons" style="display:flex; gap:12px;">
        <button class="exit-modal-btn cancel" onclick="window.closeExitModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:12px; font-weight:700; color:#475569; cursor:pointer;">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="exit-modal-btn exit" onclick="window.exitApp()" style="flex:1; padding:12px; background:#ef4444; border:none; border-radius:12px; font-weight:700; color:white; cursor:pointer;">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </div>
    </div>
  </div>

  <!-- ===== INSTALL PERMISSION MODAL ===== -->
  <div class="exit-modal-overlay" id="installPermissionModal" style="display:none;">
    <div class="install-permission-modal" style="background:white; max-width:340px; padding:24px; border-radius:24px;">
      <h2 style="margin-bottom:12px;"><i class="fas fa-download" style="color:#667eea;"></i> Enhance Your Experience</h2>
      <p style="margin-bottom:16px; color:#64748b;">To provide you with the best experience, we'd like to:</p>
      <div class="permission-features" style="margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Save business details to your contacts</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Enable push notifications for orders</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Install app for quick access</span></div>
      </div>
      <p style="font-size: 14px; color: #94a3b8; margin-bottom:20px;">Your data is secure and never shared with third parties.</p>
      <div class="permission-buttons" style="display:flex; gap:12px;">
        <button class="permission-btn cancel" onclick="window.closeInstallPermissionModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:12px; font-weight:700; color:#475569; cursor:pointer;">
          <i class="fas fa-times"></i> Skip
        </button>
        <button class="permission-btn accept" onclick="window.acceptInstallPermissions()" style="flex:1; padding:12px; background:var(--success-gradient); border:none; border-radius:12px; font-weight:700; color:white; cursor:pointer;">
          <i class="fas fa-check"></i> Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <!-- ===== LOADING SCREEN ===== -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle" style="color:white;">Digital Business</h1>
    <p id="loadingSubtitle" style="color:white; opacity:0.9;">Loading your premium business experience...</p>
  </div>

  <!-- ===== HOME PAGE ===== -->
  <div id="homePage" class="page">
    <div class="app-header">
      <div class="welcome-text">
        <h1 id="businessHeader" style="color:white;">Welcome</h1>
        <p style="color:rgba(255,255,255,0.9);">Premium business at your fingertips</p>
      </div>
      
      <div class="quick-actions">
        <div class="action-card" onclick="window.navigateTo('productsPage')">
          <div class="action-icon"><i class="fas fa-shopping-bag" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Shop Now</h3>
          <p style="font-size:11px; opacity:0.9;">Browse products</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('cartPage')">
          <div class="action-icon">
            <i class="fas fa-shopping-cart" style="font-size:24px;"></i>
            <!-- Header cart badge completely removed -->
          </div>
          <h3 style="font-size:14px; margin-top:8px;">My Cart</h3>
          <p style="font-size:11px; opacity:0.9;"><span id="cartCountMini">0</span> items</p>
        </div>
        <div class="action-card" onclick="window.openWhatsAppChat()">
          <div class="action-icon"><i class="fab fa-whatsapp" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Live Chat</h3>
          <p style="font-size:11px; opacity:0.9;">Instant support</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('contactPage')">
          <div class="action-icon"><i class="fas fa-map-marker-alt" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Location</h3>
          <p style="font-size:11px; opacity:0.9;">Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section" style="display:flex; align-items:center; gap:16px; padding:20px; background:white; margin:20px; border-radius:20px; box-shadow:var(--shadow-md);">
      <img src="" id="photo" class="profile-avatar" loading="lazy" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:3px solid var(--primary-gradient);">
      <div>
        <div class="profile-name" style="display:flex; align-items:center; gap:6px;">
          <span id="name" style="font-size:18px; font-weight:800; color:var(--dark-color);">Loading...</span>
          <i class="fas fa-badge-check verified-badge" style="color:#10b981;"></i>
        </div>
        <div class="profile-business" id="business" style="font-size:14px; color:#64748b; margin-top:4px;"></div>
      </div>
    </div>

    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; padding:0 16px; margin-bottom:16px;">
      <h2 style="font-size:18px; font-weight:800; color:var(--dark-color); display:flex; align-items:center; gap:8px;">
        <i class="fas fa-gift" style="color:#667eea;"></i> Featured Products
      </h2>
      <div class="see-all" onclick="window.navigateTo('productsPage')" style="font-size:14px; color:#667eea; font-weight:600; cursor:pointer;">
        See All <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    
    <div class="products-grid" id="featuredProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== PRODUCTS PAGE ===== -->
  <div id="productsPage" class="page">
    <div class="products-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Products & Offers</h1>
      <p style="color:#64748b; margin-top:4px;">Discover our premium collection</p>
    </div>
    
    <div class="products-search" style="position:relative; margin:16px; padding:0 4px;">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="window.filterProducts()" style="width:100%; padding:14px 20px; padding-left:50px; border:2px solid #e2e8f0; border-radius:30px; font-size:15px;">
      <i class="fas fa-search" style="position:absolute; left:24px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
    </div>
    
    <div class="products-grid" id="allProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CART PAGE ===== -->
  <div id="cartPage" class="page">
    <div class="cart-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">My Cart</h1>
      <p id="cartItemsCount" style="color:#64748b; margin-top:4px;">0 items</p>
    </div>
    <div id="cartContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CUSTOMER INFO PAGE ===== -->
  <div id="customerInfoPage" class="page">
    <div class="page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-user"></i> Customer Information</h1>
      <p style="color:#64748b; margin-top:4px;">Please confirm your details</p>
    </div>
    
    <div class="customer-form" style="margin:16px;">
      <div class="form-group">
        <label class="form-label">Full Name *</label>
        <input type="text" id="customerName" class="form-input" placeholder="Enter your full name" value="">
        <div class="error-message" id="nameError">Name is required</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Phone Number *</label>
        <input type="tel" id="customerPhone" class="form-input" placeholder="03XXXXXXXXX" value="">
        <div class="error-message" id="phoneError">Valid phone number required</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Email (Optional)</label>
        <input type="email" id="customerEmail" class="form-input" placeholder="your@email.com" value="">
      </div>
      
      <div class="pinpoint-location" onclick="window.getCurrentLocation()">
        <div class="pinpoint-icon">
          <i class="fas fa-map-pin"></i>
        </div>
        <div class="pinpoint-text">
          <div class="pinpoint-title">Use My Current Location</div>
          <div class="pinpoint-subtitle">Auto-detect your address with GPS</div>
          <div class="location-coordinates" id="locationCoords"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Delivery Address *</label>
        <div class="address-display-container">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="error-message" id="addressError">Address is required</div>
      </div>
      
      <button onclick="window.saveCustomerInfo()" class="btn-primary" style="width:100%; padding:16px; font-size:16px; margin-top:20px;">
        <i class="fas fa-arrow-right"></i> Continue to Payment
      </button>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== PAYMENT PAGE ===== -->
  <div id="paymentPage" class="page">
    <div class="page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-credit-card"></i> Payment Method</h1>
      <p style="color:#64748b; margin-top:4px;">Choose how you want to pay</p>
    </div>
    
    <div style="padding:16px;">
      <div style="background:white; border-radius:16px; padding:20px; margin-bottom:20px;">
        <h3 style="font-size:16px; font-weight:800; color:var(--dark-color); margin-bottom:12px;">Order Summary</h3>
        <div id="paymentOrderSummary"></div>
        <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:2px solid #e2e8f0;">
          <span style="font-weight:700;">Total Amount</span>
          <span style="font-size:20px; font-weight:900; color:#10b981;" id="paymentTotal">PKR 0</span>
        </div>
      </div>
      
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin:20px 0 12px;">
        <i class="fas fa-credit-card"></i> Select Payment Method
      </h3>
      
      <div class="pro-payment-grid" id="paymentMethodsGrid"></div>
      
      <button onclick="window.processPayment()" class="btn-primary" style="width:100%; padding:16px; font-size:16px; margin-top:20px;">
        <i class="fas fa-lock"></i> Pay Now & Place Order
      </button>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ABOUT PAGE ===== -->
  <div id="aboutPage" class="page">
    <div class="about-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">About Business</h1>
    </div>
    <div class="about-content" id="aboutContent" style="padding:20px; color:#475569; line-height:1.6;"></div>
    <div class="business-hours" style="padding:20px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-clock" style="color:#667eea;"></i> Business Hours
      </h3>
      <div class="hours-list" id="businessHours" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="business-hours" style="padding:20px; padding-top:0;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-calendar-times" style="color:#ef4444;"></i> Holidays
      </h3>
      <div class="hours-list" id="holidaysList" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CONTACT PAGE ===== -->
  <div id="contactPage" class="page">
    <div class="contact-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Contact Us</h1>
      <p style="color:#64748b; margin-top:4px;">Get in touch anytime</p>
    </div>
    
    <div class="contact-info" style="padding:16px;">
      <div class="contact-item" onclick="window.saveBusinessToContacts()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#667eea; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-address-card"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Save Business Contact</div>
          <div class="contact-value" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to save</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.makeCall()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#2563eb; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-phone"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Call Business</div>
          <div class="contact-value" id="contactPhone" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openWhatsAppChat()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#25D366; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fab fa-whatsapp"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp" style="font-size:16px; font-weight:700; color:var(--dark-color);">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="window.sendEmail()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#8b5cf6; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-envelope"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Email</div>
          <div class="contact-value" id="contactEmail" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openMap()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#ef4444; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Address</div>
          <div class="contact-value" id="contactAddress" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links" style="padding:16px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-share-alt" style="color:#667eea;"></i> Follow Us
      </h3>
      <div class="social-grid" id="socialGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== DELIVERY STATUS PAGE ===== -->
  <div id="deliveryPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-truck" style="color:#10b981;"></i> My Orders</h1>
      <p style="color:#64748b; margin-top:4px;">Track your orders in real-time</p>
    </div>
    
    <!-- Auto Notification Toggle -->
    <div class="auto-notify-toggle">
      <span style="font-weight:600; color:var(--dark-color);">
        <i class="fas fa-bell"></i> Auto Notifications
      </span>
      <label class="toggle-switch">
        <input type="checkbox" id="autoNotifyToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div id="deliveryContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ADMIN PAGE ===== -->
  <div id="adminPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-cog" style="color:#667eea;"></i> Business Admin</h1>
      <p style="color:#64748b; margin-top:4px;">Manage orders, tokens & deliveries</p>
    </div>
    
    <!-- Quick Actions -->
    <div class="admin-quick-actions">
      <button class="admin-quick-btn" onclick="filterPendingOrders()">
        <i class="fas fa-clock"></i> Pending
      </button>
      <button class="admin-quick-btn" onclick="filterConfirmedOrders()">
        <i class="fas fa-check-circle"></i> Confirmed
      </button>
      <button class="admin-quick-btn" onclick="filterAllOrders()">
        <i class="fas fa-list"></i> All
      </button>
      <button class="admin-quick-btn" onclick="refreshOrders()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    
    <!-- Token Management -->
    <div class="token-management">
      <div class="token-header">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color);">
          <i class="fas fa-ticket-alt" style="color:#667eea;"></i> Order Tokens
        </h3>
        <button onclick="window.generateNewToken()" style="background:var(--success-gradient); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer;">
          <i class="fas fa-plus"></i> Generate
        </button>
      </div>
      
      <div class="token-stats" id="tokenStats">
        <div class="stat-card" style="background:#f8fafc; padding:12px; border-radius:12px; text-align:center;">
          <div class="stat-number" id="totalTokensCount" style="font-size:24px; font-weight:900; color:#667eea;">0</div>
          <div class="stat-label" style="font-size:12px; color:#64748b;">Total</div>
        </div>
        <div class="stat-card" style="background:#f8fafc; padding:12px; border-radius:12px; text-align:center;">
          <div class="stat-number" id="activeTokensCount" style="font-size:24px; font-weight:900; color:#10b981;">0</div>
          <div class="stat-label" style="font-size:12px; color:#64748b;">Active</div>
        </div>
        <div class="stat-card" style="background:#f8fafc; padding:12px; border-radius:12px; text-align:center;">
          <div class="stat-number" id="todayTokensCount" style="font-size:24px; font-weight:900; color:#f59e0b;">0</div>
          <div class="stat-label" style="font-size:12px; color:#64748b;">Today</div>
        </div>
      </div>
      
      <!-- Search -->
      <div style="margin-bottom:16px;">
        <input type="text" id="adminTokenSearch" placeholder="Search by token, order ID, customer..." 
               style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;"
               onkeyup="window.searchAdminTokens()">
      </div>
      
      <!-- Token List -->
      <div class="token-list" id="tokenList"></div>
    </div>
    
    <!-- Admin Actions -->
    <div style="margin:16px; display:flex; gap:12px;">
      <button onclick="window.logoutAdmin()" style="flex:1; padding:12px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
      <button onclick="window.sendNotificationToAll()" style="flex:1; padding:12px; background:var(--warning-gradient); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">
        <i class="fas fa-bell"></i> Send Alert
      </button>
    </div>
    
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== LOGIN PAGE ===== -->
  <div id="loginPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-lock" style="color:#667eea;"></i> Admin Login</h1>
      <p style="color:#64748b; margin-top:4px;">Enter password to access admin panel</p>
    </div>
    
    <div class="login-page-content" style="padding:24px;">
      <div class="login-title" style="font-size:20px; font-weight:800; color:var(--dark-color); margin-bottom:8px;">Admin Access</div>
      <div class="login-subtitle" style="color:#64748b; margin-bottom:24px;">Enter the admin password to continue</div>
      
      <input type="password" class="password-input" id="adminPasswordInput" 
             placeholder="Enter password" onkeypress="window.handleLoginKeypress(event)"
             style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:12px; font-size:16px;">
      
      <button onclick="window.attemptLogin()" class="admin-btn success" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:700; font-size:16px; margin-top:20px; cursor:pointer;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="password-hint" id="passwordHint" style="margin-top:20px; padding:16px; background:#f1f5f9; border-radius:12px; color:#64748b; font-size:14px;"></div>
      
      <div id="logoutSection" style="display:none; margin-top: 30px;">
        <button onclick="window.logoutAdmin()" class="logout-btn" style="margin: 0 auto; padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== BOTTOM NAVIGATION ===== -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="window.navigateTo('homePage')">
      <div class="nav-icon">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('productsPage')">
      <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
      <div class="nav-label">Products</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('cartPage')">
      <div class="nav-icon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
      </div>
      <div class="nav-label">Cart</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('aboutPage')">
      <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
      <div class="nav-label">About</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('contactPage')">
      <div class="nav-icon"><i class="fas fa-phone"></i></div>
      <div class="nav-label">Contact</div>
    </div>
  </div>
</div>

<!-- ===== NOTIFICATION ALERT ===== -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- ===== DELIVERY STATUS MODAL ===== -->
<div class="delivery-modal-overlay" id="deliveryStatusModal" style="display:none;">
  <div class="delivery-modal" style="background:white; max-width:340px; width:90%; border-radius:24px; position:relative; padding:20px;">
    <button onclick="window.closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">×</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;"></div>
  </div>
</div>

<!-- ===== ORDER CONFIRMATION MODAL ===== -->
<div class="modal-overlay" id="orderConfirmationModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('orderConfirmationModal')">×</button>
    <div style="padding:25px;" id="orderConfirmationContent"></div>
  </div>
</div>

<!-- ===== PAYMENT DETAILS MODAL ===== -->
<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('paymentDetailsModal')">×</button>
    <div style="padding:25px;">
      <h2 style="font-size:22px; font-weight:800; color:var(--dark-color); margin-bottom:20px;" id="paymentMethodTitle">
        Payment Details
      </h2>
      <div id="paymentDetailsContent"></div>
      <button onclick="window.completePaymentAndConfirmOrder()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:var(--border-radius-md); font-size:17px; font-weight:800; cursor:pointer; margin-top:25px;">
        <i class="fas fa-check-circle"></i> Confirm Payment
      </button>
    </div>
  </div>
</div>

<!-- ===== PRODUCT MODAL ===== -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('productModal')">×</button>
    
    <div class="product-modal-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-modal-image" loading="lazy">
    </div>
    
    <div style="padding:25px;">
      <div id="modalPrice" class="modal-price-container"></div>
      
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="window.buyNowFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button onclick="window.addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE CLIENT =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== MAIN APP VARIABLES =====
let card = {};
let currentProduct = null;
let cart = [];
let currentPage = 'loadingScreen';
let deliveryStatusData = [];
let businessAdminPassword = "";
let isAdminLoggedIn = false;
let currentBusinessId = '';
let orders = [];
let orderTokens = [];
let notificationPermission = false;
let innerNotifications = [];
let unreadNotifications = 0;
let navigationHistory = [];

// Auto notification setting
let autoNotify = true;

// Customer info
let customerInfo = {
  name: '',
  phone: '',
  email: '',
  address: '',
  location: { lat: null, lng: null }
};
let selectedPaymentMethod = 'cod';
let paymentProof = null;
let pendingOrder = null;
let skipProof = false;

// PWA Install
let deferredPrompt = null;
let installButtonShown = false;

// Real-time subscription
let ordersSubscription = null;

// ===== ATTACH FUNCTIONS =====
window.navigateTo = navigateTo;
window.goBack = goBack;
window.toggleNotificationDrawer = toggleNotificationDrawer;
window.markAllNotificationsAsRead = markAllNotificationsAsRead;
window.enableNotifications = enableNotifications;
window.saveBusinessToContacts = saveBusinessToContacts;
window.checkDeliveryStatus = checkDeliveryStatus;
window.toggleLogin = toggleLogin;
window.shareBusiness = shareBusiness;
window.openWhatsAppChat = openWhatsAppChat;
window.makeCall = makeCall;
window.sendEmail = sendEmail;
window.openMap = openMap;
window.zoomImage = zoomImage;
window.closeImageZoom = closeImageZoom;
window.filterProducts = filterProducts;
window.addToCart = addToCart;
window.buyNow = buyNow;
window.buyNowFromModal = buyNowFromModal;
window.removeFromCart = removeFromCart;
window.updateQuantity = updateQuantity;
window.closeModal = closeModal;
window.openModal = openModal;
window.attemptLogin = attemptLogin;
window.handleLoginKeypress = handleLoginKeypress;
window.logoutAdmin = logoutAdmin;
window.generateNewToken = generateNewToken;
window.searchAdminTokens = searchAdminTokens;
window.viewOrderDetails = viewOrderDetails;
window.updateOrderStatus = updateOrderStatus;
window.sendNotificationToAll = sendNotificationToAll;
window.closeExitModal = closeExitModal;
window.exitApp = exitApp;
window.closeInstallPermissionModal = closeInstallPermissionModal;
window.acceptInstallPermissions = acceptInstallPermissions;
window.closeDeliveryModal = closeDeliveryModal;
window.addToCartFromModal = addToCartFromModal;
window.showProductModal = showProductModal;
window.saveCustomerInfo = saveCustomerInfo;
window.getCurrentLocation = getCurrentLocation;
window.selectPaymentMethod = selectPaymentMethod;
window.processPayment = processPayment;
window.completePaymentAndConfirmOrder = completePaymentAndConfirmOrder;
window.zoomProductImage = zoomProductImage;
window.closeProductZoom = closeProductZoom;
window.toggleAddressEdit = toggleAddressEdit;
window.saveAddressEdit = saveAddressEdit;
window.showPaymentProofPopup = showPaymentProofPopup;
window.closePaymentProofPopup = closePaymentProofPopup;
window.handlePopupProofUpload = handlePopupProofUpload;
window.confirmPaymentWithProof = confirmPaymentWithProof;
window.sendReceiptToWhatsApp = sendReceiptToWhatsApp;
window.sendReceiptToEmail = sendReceiptToEmail;
window.downloadReceipt = downloadReceipt;
window.downloadReceiptAsImage = downloadReceiptAsImage;
window.closeReceiptModal = closeReceiptModal;
window.confirmOrder = confirmOrder;
window.filterPendingOrders = filterPendingOrders;
window.filterConfirmedOrders = filterConfirmedOrders;
window.filterAllOrders = filterAllOrders;
window.refreshOrders = refreshOrders;
window.downloadOrderTicket = downloadOrderTicket;
window.toggleProofUpload = toggleProofUpload;

// ===== DATA ISOLATION =====
function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) {
    localStorage.setItem(getStorageKey(key), value);
  },
  getItem: function(key) {
    return localStorage.getItem(getStorageKey(key));
  },
  removeItem: function(key) {
    localStorage.removeItem(getStorageKey(key));
  }
};

// ===== PASSWORD GENERATOR =====
function generateAdminPassword(cardId) {
  const idPart = cardId ? cardId.substring(0, 6).toLowerCase() : 'default';
  return `business123_${idPart}`;
}

// ===== FIXED: SAVE CONTACT =====
function saveBusinessToContacts() {
  if (!card.name || !card.phone) {
    showNotification('❌ Business information incomplete');
    return;
  }
  
  const contact = `BEGIN:VCARD
VERSION:3.0
FN:${card.businessName || card.name}
TEL:${card.phone}
EMAIL:${card.email || ''}
ADR:${card.address || ''}
NOTE:Digital Business Card
END:VCARD`;
  
  const blob = new Blob([contact], { type: 'text/vcard' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${card.businessName || 'business'}.vcf`;
  a.click();
  
  showNotification('✅ Contact file downloaded! Save to phone');
}

// ===== FIXED: CHECK DELIVERY STATUS =====
function checkDeliveryStatus() {
  if (!customerInfo.phone) {
    showNotification('Please add your phone number first');
    navigateTo('customerInfoPage');
    return;
  }
  navigateTo('deliveryPage');
  loadDeliveryStatus();
}

// ===== FIXED: UPDATE CART COUNT (Header cart badge removed) =====
function updateCartCount() {
  const count = cart.length;
  
  // Bottom navigation cart badge
  const cartBadge = document.getElementById('cartBadge');
  if (cartBadge) {
    if (count > 0) {
      cartBadge.textContent = count > 99 ? '99+' : count;
      cartBadge.style.display = 'flex';
    } else {
      cartBadge.style.display = 'none';
    }
  }
  
  // Mini cart count in home page
  const cartCountMini = document.getElementById('cartCountMini');
  if (cartCountMini) cartCountMini.textContent = count;
  
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
}

// ===== FIXED: SELECT PAYMENT METHOD WITH BARCODE IN POPUP =====
function selectPaymentMethod(method) {
  selectedPaymentMethod = method;
  
  document.querySelectorAll('.pro-payment-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  const selectedCards = document.querySelectorAll(`.pro-payment-card[onclick*="${method}"]`);
  selectedCards.forEach(card => card.classList.add('selected'));
}

// ===== FIXED: SHOW PAYMENT PROOF POPUP WITH BARCODE =====
function showPaymentProofPopup(method) {
  selectedPaymentMethod = method;
  const popup = document.getElementById('paymentProofPopup');
  const instructions = document.getElementById('paymentInstructions');
  const barcodeContainer = document.getElementById('barcodePreviewContainer');
  const barcodeImage = document.getElementById('barcodePreviewImage');
  
  // Reset
  document.getElementById('skipProofCheckbox').checked = false;
  skipProof = false;
  document.getElementById('proofUploadSection').style.display = 'block';
  document.getElementById('popupProofInput').value = '';
  document.getElementById('popupProofPreview').src = '';
  document.getElementById('popupProofPreview').classList.remove('show');
  document.getElementById('popupUploadArea').classList.remove('has-file');
  document.getElementById('confirmPaymentBtn').disabled = true;
  paymentProof = null;
  
  // Check for barcode
  let barcodeUrl = null;
  if (method === 'jazzcash' && card.payments?.gateways?.jazzcash?.barcode) {
    barcodeUrl = card.payments.gateways.jazzcash.barcode;
  } else if (method === 'easypaisa' && card.payments?.gateways?.easypaisa?.barcode) {
    barcodeUrl = card.payments.gateways.easypaisa.barcode;
  }
  
  if (barcodeUrl) {
    barcodeImage.src = barcodeUrl;
    barcodeContainer.style.display = 'block';
  } else {
    barcodeContainer.style.display = 'none';
  }
  
  if (method === 'jazzcash') {
    instructions.innerHTML = `
      <p><i class="fas fa-mobile-alt"></i> Complete payment via JazzCash</p>
      <p><i class="fas fa-arrow-right"></i> Send to: <strong>${card.payments?.gateways?.jazzcash?.number || '03001234567'}</strong></p>
      ${barcodeUrl ? '<p><i class="fas fa-qrcode"></i> Scan QR code above to pay</p>' : ''}
      <p><i class="fas fa-info-circle"></i> After payment, you can:</p>
      <p>✅ Upload screenshot OR</p>
      <p>✅ Send transaction ID via WhatsApp</p>
    `;
  } else if (method === 'easypaisa') {
    instructions.innerHTML = `
      <p><i class="fas fa-wallet"></i> Complete payment via EasyPaisa</p>
      <p><i class="fas fa-arrow-right"></i> Send to: <strong>${card.payments?.gateways?.easypaisa?.number || '03001234567'}</strong></p>
      ${barcodeUrl ? '<p><i class="fas fa-qrcode"></i> Scan QR code above to pay</p>' : ''}
      <p><i class="fas fa-info-circle"></i> After payment:</p>
      <p>✅ Upload screenshot OR</p>
      <p>✅ Send transaction ID</p>
    `;
  } else if (method === 'bank') {
    instructions.innerHTML = `
      <p><i class="fas fa-university"></i> Complete bank transfer</p>
      <p><strong>${card.payments?.gateways?.bank?.bankName || 'HBL'}</strong></p>
      <p>Account: ${card.payments?.gateways?.bank?.accountNumber || '1234567890'}</p>
      <p><i class="fas fa-info-circle"></i> After transfer:</p>
      <p>✅ Upload screenshot OR</p>
      <p>✅ Send reference number</p>
    `;
  } else if (method === 'card') {
    instructions.innerHTML = `
      <p><i class="fas fa-credit-card"></i> Complete card payment</p>
      <p><i class="fas fa-info-circle"></i> After payment:</p>
      <p>✅ Upload confirmation screenshot OR</p>
      <p>✅ Send transaction ID</p>
    `;
  } else if (method === 'crypto') {
    instructions.innerHTML = `
      <p><i class="fab fa-bitcoin"></i> Send crypto</p>
      <p><i class="fas fa-info-circle"></i> After sending:</p>
      <p>✅ Upload screenshot OR</p>
      <p>✅ Send transaction hash</p>
    `;
  }
  
  popup.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

// ===== FIXED: DOWNLOAD ORDER TICKET AS IMAGE (NOT TEXT) =====
function downloadOrderTicket(token) {
  const order = orders.find(o => o.token === token);
  if (!order) return;
  
  // Create a temporary div with the exact ticket design
  const ticketDiv = document.createElement('div');
  ticketDiv.style.width = '380px';
  ticketDiv.style.padding = '24px';
  ticketDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
  ticketDiv.style.borderRadius = '24px';
  ticketDiv.style.color = 'white';
  ticketDiv.style.fontFamily = 'Poppins, sans-serif';
  
  const date = new Date(order.created_at).toLocaleString();
  let itemsHtml = '';
  if (order.items && Array.isArray(order.items)) {
    order.items.forEach(item => {
      itemsHtml += `
        <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:13px;">
          <span>${item.title} x${item.quantity}</span>
          <span>PKR ${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `;
    });
  }
  
  ticketDiv.innerHTML = `
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:12px;">
      <span style="font-size:18px; font-weight:900;">${order.token}</span>
      <span style="font-size:12px; opacity:0.9;">${date}</span>
    </div>
    <div style="margin-bottom:20px; text-align:center;">
      <i class="fas fa-check-circle" style="font-size:48px; color:#10b981;"></i>
      <h3 style="color:white; margin-top:12px;">Order Ticket</h3>
    </div>
    <div style="margin-bottom:8px; display:flex; justify-content:space-between;">
      <span>Order ID:</span>
      <span style="font-weight:800;">${order.order_id}</span>
    </div>
    <div style="margin-bottom:8px; display:flex; justify-content:space-between;">
      <span>Customer:</span>
      <span>${order.customer_name}</span>
    </div>
    <div style="margin-bottom:8px; display:flex; justify-content:space-between;">
      <span>Phone:</span>
      <span>${order.customer_phone}</span>
    </div>
    <div style="margin:16px 0; padding:12px 0; border-top:2px dashed rgba(255,255,255,0.3); border-bottom:2px dashed rgba(255,255,255,0.3);">
      ${itemsHtml}
    </div>
    <div style="margin-bottom:8px; display:flex; justify-content:space-between;">
      <span>Subtotal:</span>
      <span>PKR ${order.subtotal.toFixed(2)}</span>
    </div>
    <div style="margin-bottom:8px; display:flex; justify-content:space-between;">
      <span>Delivery:</span>
      <span>PKR ${order.delivery_charge.toFixed(2)}</span>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:12px; font-size:18px; font-weight:800;">
      <span>Total</span>
      <span>PKR ${order.total.toFixed(2)}</span>
    </div>
    <div style="text-align:center; margin-top:20px; font-size:12px; opacity:0.9;">
      <i class="fas fa-shield-alt"></i> Payment: ${getPaymentMethodName(order.payment_method)}
    </div>
  `;
  
  document.body.appendChild(ticketDiv);
  
  html2canvas(ticketDiv, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = `order-ticket-${token}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    document.body.removeChild(ticketDiv);
    showNotification('✅ Order ticket downloaded as image');
  }).catch(err => {
    console.error('Error:', err);
    showNotification('❌ Could not create image');
    document.body.removeChild(ticketDiv);
  });
}

// ===== FIXED: DOWNLOAD RECEIPT AS IMAGE =====
function downloadReceiptAsImage() {
  const order = window.currentReceiptOrder;
  if (!order) {
    showNotification('❌ Receipt not found');
    return;
  }
  
  // Create receipt element with exact design
  const receiptDiv = document.createElement('div');
  receiptDiv.style.width = '380px';
  receiptDiv.style.padding = '24px';
  receiptDiv.style.background = 'white';
  receiptDiv.style.borderRadius = '32px';
  receiptDiv.style.fontFamily = 'Poppins, sans-serif';
  receiptDiv.style.boxShadow = '0 25px 50px -12px rgba(0,0,0,0.25)';
  
  const date = new Date().toLocaleString();
  
  receiptDiv.innerHTML = `
    <div style="text-align:center; margin-bottom:24px;">
      <i class="fas fa-check-circle" style="font-size:60px; color:#10b981; margin-bottom:12px;"></i>
      <h2 style="font-size:24px; font-weight:800; color:#0f172a; margin-bottom:4px;">Order Confirmed!</h2>
      <p style="color:#64748b; font-size:14px;">Your receipt is ready</p>
    </div>
    
    <div style="background:#f8fafc; border-radius:20px; padding:20px; margin:20px 0;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #e2e8f0;">
        <span style="color:#64748b; font-size:14px;">Order ID</span>
        <span style="font-weight:700; color:#0f172a; font-size:14px;">${order.order_id}</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #e2e8f0;">
        <span style="color:#64748b; font-size:14px;">Token</span>
        <span style="font-weight:700; color:#667eea; font-size:14px;">${order.token}</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #e2e8f0;">
        <span style="color:#64748b; font-size:14px;">Date</span>
        <span style="font-weight:700; color:#0f172a; font-size:14px;">${date}</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #e2e8f0;">
        <span style="color:#64748b; font-size:14px;">Customer</span>
        <span style="font-weight:700; color:#0f172a; font-size:14px;">${order.customer_name}</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #e2e8f0;">
        <span style="color:#64748b; font-size:14px;">Items</span>
        <span style="font-weight:700; color:#0f172a; font-size:14px;">${order.items.length}</span>
      </div>
      <div style="display:flex; justify-content:space-between; padding-top:12px;">
        <span style="color:#0f172a; font-size:16px; font-weight:800;">Total</span>
        <span style="color:#10b981; font-size:18px; font-weight:900;">PKR ${order.total.toFixed(2)}</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(receiptDiv);
  
  html2canvas(receiptDiv, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = `receipt-${order.order_id}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    document.body.removeChild(receiptDiv);
    showNotification('✅ Receipt downloaded as image');
  }).catch(err => {
    console.error('Error:', err);
    showNotification('❌ Could not create image');
    document.body.removeChild(receiptDiv);
  });
}

// ===== FIXED: UPDATE ORDER STATUS WITH AUTO NOTIFY =====
async function updateOrderStatus(orderId) {
  const status = document.getElementById('orderStatusSelect').value;
  
  const { error } = await supa
    .from('orders')
    .update({ status: status, updated_at: new Date().toISOString() })
    .eq('id', orderId);
  
  if (!error) {
    showNotification('✅ Order status updated to ' + status);
    
    if (status === 'confirmed') {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        showReceipt(order);
      }
    }
    
    closeModal('orderConfirmationModal');
    await loadOrdersFromDatabase();
    
    // Auto notify if enabled
    const autoNotify = document.getElementById('autoNotifyToggle')?.checked || true;
    if (autoNotify) {
      const order = orders.find(o => o.id === orderId);
      if (order && order.customer_phone) {
        const message = `Your order #${order.order_id} status has been updated to: ${status}`;
        window.open(`https://wa.me/${order.customer_phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
      }
    }
    
  } else {
    showNotification('❌ Error updating order');
  }
}

// ===== CUSTOMER INFO FUNCTIONS (keep existing) =====
function loadCustomerInfo() {
  const saved = isolatedLocalStorage.getItem('customerInfo');
  if (saved) {
    try {
      customerInfo = JSON.parse(saved);
      
      const addressContainer = document.querySelector('.address-display-container');
      if (addressContainer) {
        addressContainer.innerHTML = `
          <div class="address-display">
            <div class="address-text">${customerInfo.address || 'No address saved'}</div>
            <button class="address-edit-btn" onclick="toggleAddressEdit()">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        `;
      }
      
      document.getElementById('customerName').value = customerInfo.name || '';
      document.getElementById('customerPhone').value = customerInfo.phone || '';
      document.getElementById('customerEmail').value = customerInfo.email || '';
      
      let addressField = document.getElementById('customerAddress');
      if (!addressField) {
        addressField = document.createElement('textarea');
        addressField.id = 'customerAddress';
        addressField.style.display = 'none';
        document.querySelector('.address-display-container').appendChild(addressField);
      }
      addressField.value = customerInfo.address || '';
      
      if (customerInfo.location && customerInfo.location.lat) {
        document.getElementById('locationCoords').textContent = 
          `📍 ${customerInfo.location.lat.toFixed(6)}, ${customerInfo.location.lng.toFixed(6)}`;
      }
    } catch (e) {
      console.error('Error loading customer info:', e);
    }
  } else {
    const addressContainer = document.querySelector('.address-display-container');
    if (addressContainer) {
      addressContainer.innerHTML = `
        <div class="address-display">
          <div class="address-text">No address saved</div>
          <button class="address-edit-btn" onclick="toggleAddressEdit()">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      `;
    }
  }
}

function toggleAddressEdit() {
  const container = document.querySelector('.address-display-container');
  const currentAddress = customerInfo.address || '';
  
  container.innerHTML = `
    <div class="address-edit-mode">
      <textarea id="editAddressField" class="form-input" rows="3" placeholder="Enter your address">${currentAddress}</textarea>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn-primary" style="flex:1;" onclick="saveAddressEdit()">
          <i class="fas fa-save"></i> Save
        </button>
        <button class="btn-secondary" style="flex:1;" onclick="loadCustomerInfo()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  `;
}

function saveAddressEdit() {
  const newAddress = document.getElementById('editAddressField').value;
  if (newAddress) {
    customerInfo.address = newAddress;
    
    let addressField = document.getElementById('customerAddress');
    if (!addressField) {
      addressField = document.createElement('textarea');
      addressField.id = 'customerAddress';
      addressField.style.display = 'none';
      document.querySelector('.address-display-container').appendChild(addressField);
    }
    addressField.value = newAddress;
    
    isolatedLocalStorage.setItem('customerInfo', JSON.stringify(customerInfo));
    loadCustomerInfo();
    showNotification('✅ Address updated');
  }
}

function saveCustomerInfo() {
  const name = document.getElementById('customerName').value.trim();
  const phone = document.getElementById('customerPhone').value.trim();
  const email = document.getElementById('customerEmail').value.trim();
  const address = customerInfo.address || document.getElementById('customerAddress')?.value || '';
  
  let isValid = true;
  
  if (!name) {
    document.getElementById('nameError').style.display = 'block';
    document.getElementById('customerName').classList.add('error');
    isValid = false;
  } else {
    document.getElementById('nameError').style.display = 'none';
    document.getElementById('customerName').classList.remove('error');
  }
  
  const phoneRegex = /^03[0-9]{9}$/;
  if (!phone || !phoneRegex.test(phone)) {
    document.getElementById('phoneError').style.display = 'block';
    document.getElementById('customerPhone').classList.add('error');
    isValid = false;
  } else {
    document.getElementById('phoneError').style.display = 'none';
    document.getElementById('customerPhone').classList.remove('error');
  }
  
  if (!address) {
    document.getElementById('addressError').style.display = 'block';
    isValid = false;
  } else {
    document.getElementById('addressError').style.display = 'none';
  }
  
  if (!isValid) return;
  
  customerInfo = {
    name: name,
    phone: phone,
    email: email,
    address: address,
    location: customerInfo.location || { lat: null, lng: null }
  };
  
  isolatedLocalStorage.setItem('customerInfo', JSON.stringify(customerInfo));
  
  navigateTo('paymentPage');
  loadPaymentPage();
}

function getCurrentLocation() {
  if (!navigator.geolocation) {
    showNotification('❌ Geolocation not supported');
    return;
  }
  
  showNotification('📍 Getting your location...');
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      customerInfo.location = { lat, lng };
      document.getElementById('locationCoords').textContent = 
        `📍 ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(response => response.json())
        .then(data => {
          if (data.display_name) {
            customerInfo.address = data.display_name;
            
            let addressField = document.getElementById('customerAddress');
            if (!addressField) {
              addressField = document.createElement('textarea');
              addressField.id = 'customerAddress';
              addressField.style.display = 'none';
              document.querySelector('.address-display-container').appendChild(addressField);
            }
            addressField.value = data.display_name;
            
            loadCustomerInfo();
            showNotification('✅ Location detected!');
          }
        })
        .catch(() => {
          showNotification('⚠️ Location coordinates captured');
        });
    },
    (error) => {
      showNotification('❌ Error getting location: ' + error.message);
    }
  );
}

// ===== PAYMENT FUNCTIONS =====
function loadPaymentPage() {
  const paymentGrid = document.getElementById('paymentMethodsGrid');
  const orderSummary = document.getElementById('paymentOrderSummary');
  
  let subtotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  let deliveryCharge = 0;
  if (customerInfo.address) {
    const addressLower = customerInfo.address.toLowerCase();
    if (addressLower.includes('karachi') || addressLower.includes('lahore') || addressLower.includes('islamabad')) {
      deliveryCharge = 150;
    } else {
      deliveryCharge = 300;
    }
  }
  
  const total = subtotal + deliveryCharge;
  
  let itemsHtml = '';
  cart.forEach(item => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    itemsHtml += `
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;">
        <span>${item.title} x${item.quantity}</span>
        <span style="font-weight:600;">PKR ${itemTotal.toFixed(2)}</span>
      </div>
    `;
  });
  
  orderSummary.innerHTML = `
    ${itemsHtml}
    <div style="display:flex; justify-content:space-between; margin-top:8px; padding-top:8px; border-top:1px solid #e2e8f0;">
      <span>Subtotal</span>
      <span>PKR ${subtotal.toFixed(2)}</span>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:4px;">
      <span>Delivery</span>
      <span>PKR ${deliveryCharge.toFixed(2)}</span>
    </div>
  `;
  
  document.getElementById('paymentTotal').textContent = `PKR ${total.toFixed(2)}`;
  
  let methodsHtml = '';
  
  methodsHtml += `
    <div class="pro-payment-card ${selectedPaymentMethod === 'cod' ? 'selected' : ''}" onclick="window.selectPaymentMethod('cod')">
      <div class="pro-payment-icon" style="background:#10b981;">
        <i class="fas fa-truck"></i>
      </div>
      <div style="font-weight:700; font-size:14px;">Cash on Delivery</div>
      <div style="font-size:11px; color:#64748b;">Pay when order arrives</div>
    </div>
  `;
  
  if (card.payments?.gateways?.jazzcash?.active) {
    methodsHtml += `
      <div class="pro-payment-card ${selectedPaymentMethod === 'jazzcash' ? 'selected' : ''}" onclick="window.selectPaymentMethod('jazzcash')">
        <div class="pro-payment-icon" style="background:#FF6B00;">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div style="font-weight:700; font-size:14px;">JazzCash</div>
        <div style="font-size:11px; color:#64748b;">${card.payments.gateways.jazzcash.number || 'Pay via app'}</div>
      </div>
    `;
  }
  
  if (card.payments?.gateways?.easypaisa?.active) {
    methodsHtml += `
      <div class="pro-payment-card ${selectedPaymentMethod === 'easypaisa' ? 'selected' : ''}" onclick="window.selectPaymentMethod('easypaisa')">
        <div class="pro-payment-icon" style="background:#0A5C36;">
          <i class="fas fa-wallet"></i>
        </div>
        <div style="font-weight:700; font-size:14px;">EasyPaisa</div>
        <div style="font-size:11px; color:#64748b;">${card.payments.gateways.easypaisa.number || 'Pay via app'}</div>
      </div>
    `;
  }
  
  if (card.payments?.gateways?.bank?.active) {
    methodsHtml += `
      <div class="pro-payment-card ${selectedPaymentMethod === 'bank' ? 'selected' : ''}" onclick="window.selectPaymentMethod('bank')">
        <div class="pro-payment-icon" style="background:#2563eb;">
          <i class="fas fa-university"></i>
        </div>
        <div style="font-weight:700; font-size:14px;">Bank Transfer</div>
        <div style="font-size:11px; color:#64748b;">${card.payments.gateways.bank.bankName || 'Direct transfer'}</div>
      </div>
    `;
  }
  
  if (card.payments?.gateways?.card?.active) {
    methodsHtml += `
      <div class="pro-payment-card ${selectedPaymentMethod === 'card' ? 'selected' : ''}" onclick="window.selectPaymentMethod('card')">
        <div class="pro-payment-icon" style="background:#8b5cf6;">
          <i class="fas fa-credit-card"></i>
        </div>
        <div style="font-weight:700; font-size:14px;">Card Payment</div>
        <div style="font-size:11px; color:#64748b;">Visa / Mastercard</div>
      </div>
    `;
  }
  
  if (card.payments?.gateways?.crypto?.active) {
    methodsHtml += `
      <div class="pro-payment-card ${selectedPaymentMethod === 'crypto' ? 'selected' : ''}" onclick="window.selectPaymentMethod('crypto')">
        <div class="pro-payment-icon" style="background:#f7931a;">
          <i class="fab fa-bitcoin"></i>
        </div>
        <div style="font-weight:700; font-size:14px;">Cryptocurrency</div>
        <div style="font-size:11px; color:#64748b;">BTC, ETH, USDT</div>
      </div>
    `;
  }
  
  paymentGrid.innerHTML = methodsHtml;
}

function showPaymentDetails(method) {
  const detailsModal = document.getElementById('paymentDetailsModal');
  const title = document.getElementById('paymentMethodTitle');
  const content = document.getElementById('paymentDetailsContent');
  
  if (method === 'jazzcash' && card.payments?.gateways?.jazzcash) {
    title.innerHTML = 'JazzCash Payment';
    content.innerHTML = `
      <div style="text-align:center;">
        <div style="margin-bottom:20px;">
          <div style="font-size:15px; color:#64748b; margin-bottom:12px;">Send payment to:</div>
          <div style="font-size:24px; font-weight:900; color:#FF6B00; margin:15px 0; background:rgba(255,107,0,0.1); padding:15px; border-radius:16px;">
            ${card.payments.gateways.jazzcash.number || '03001234567'}
          </div>
        </div>
        <div style="background:#f8fafc; padding:16px; border-radius:12px;">
          <div style="font-size:13px; color:#475569;">Amount to pay:</div>
          <div style="font-size:20px; font-weight:800; color:#10b981; margin-top:8px;" id="paymentAmountDisplay"></div>
        </div>
      </div>
    `;
  } else if (method === 'easypaisa' && card.payments?.gateways?.easypaisa) {
    title.innerHTML = 'EasyPaisa Payment';
    content.innerHTML = `
      <div style="text-align:center;">
        <div style="margin-bottom:20px;">
          <div style="font-size:15px; color:#64748b; margin-bottom:12px;">Send payment to:</div>
          <div style="font-size:24px; font-weight:900; color:#0A5C36; margin:15px 0; background:rgba(10,92,54,0.1); padding:15px; border-radius:16px;">
            ${card.payments.gateways.easypaisa.number || '03001234567'}
          </div>
        </div>
        <div style="background:#f8fafc; padding:16px; border-radius:12px;">
          <div style="font-size:13px; color:#475569;">Amount to pay:</div>
          <div style="font-size:20px; font-weight:800; color:#10b981; margin-top:8px;" id="paymentAmountDisplay"></div>
        </div>
      </div>
    `;
  } else if (method === 'bank' && card.payments?.gateways?.bank) {
    title.innerHTML = 'Bank Transfer';
    content.innerHTML = `
      <div style="background:#f8fafc; border-radius:16px; padding:20px;">
        <div style="margin-bottom:16px;">
          <div style="font-size:13px; color:#64748b;">Bank Name</div>
          <div style="font-size:18px; font-weight:800; color:var(--dark-color);">${card.payments.gateways.bank.bankName || 'HBL'}</div>
        </div>
        <div style="margin-bottom:16px;">
          <div style="font-size:13px; color:#64748b;">Account Title</div>
          <div style="font-size:16px; font-weight:700; color:var(--dark-color);">${card.payments.gateways.bank.accountTitle || 'Business Account'}</div>
        </div>
        <div style="margin-bottom:16px;">
          <div style="font-size:13px; color:#64748b;">Account Number</div>
          <div style="font-size:18px; font-weight:900; color:#2563eb; background:rgba(37,99,235,0.1); padding:10px; border-radius:8px;">${card.payments.gateways.bank.accountNumber || '1234567890'}</div>
        </div>
        <div style="background:white; padding:16px; border-radius:12px;">
          <div style="font-size:13px; color:#475569;">Amount to transfer:</div>
          <div style="font-size:20px; font-weight:800; color:#10b981; margin-top:8px;" id="paymentAmountDisplay"></div>
        </div>
      </div>
    `;
  } else if (method === 'card' && card.payments?.gateways?.card) {
    title.innerHTML = 'Card Payment';
    content.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <i class="fas fa-credit-card" style="font-size:48px; color:#8b5cf6; margin-bottom:16px;"></i>
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:8px;">Secure Card Payment</h3>
        <p style="color:#64748b; margin-bottom:20px;">You will be redirected to complete payment</p>
        <div style="background:#f8fafc; border-radius:12px; padding:16px;">
          <div style="font-size:14px; color:#475569; margin-bottom:8px;">Processor: ${card.payments.gateways.card.processor || 'Stripe'}</div>
          <div style="font-size:20px; font-weight:800; color:#10b981;" id="paymentAmountDisplay"></div>
        </div>
      </div>
    `;
  } else if (method === 'crypto' && card.payments?.gateways?.crypto) {
    title.innerHTML = 'Cryptocurrency Payment';
    content.innerHTML = `
      <div style="text-align:center;">
        <div style="margin-bottom:20px;">
          <div style="font-size:15px; color:#64748b; margin-bottom:12px;">Send crypto to:</div>
          <div style="font-size:14px; font-weight:700; word-break:break-all; background:#f8fafc; padding:15px; border-radius:12px;">
            ${card.payments.gateways.crypto.walletAddress || '0x742d35Cc6634C0532925a3b844Bc454e4438f44e'}
          </div>
        </div>
        <div style="background:#f8fafc; padding:16px; border-radius:12px;">
          <div style="font-size:13px; color:#475569;">Amount in USD:</div>
          <div style="font-size:20px; font-weight:800; color:#10b981; margin-top:8px;" id="paymentAmountDisplay"></div>
          <div style="font-size:11px; color:#94a3b8; margin-top:4px;">Network: ${card.payments.gateways.crypto.network || 'ERC-20'}</div>
        </div>
      </div>
    `;
  }
  
  setTimeout(() => {
    const amountEl = document.getElementById('paymentAmountDisplay');
    if (amountEl) {
      const totalEl = document.getElementById('paymentTotal');
      amountEl.textContent = totalEl ? totalEl.textContent : 'PKR 0';
    }
  }, 100);
  
  openModal('paymentDetailsModal');
}

// ===== PAYMENT PROOF POPUP FUNCTIONS =====
function toggleProofUpload() {
  skipProof = document.getElementById('skipProofCheckbox').checked;
  const uploadSection = document.getElementById('proofUploadSection');
  const confirmBtn = document.getElementById('confirmPaymentBtn');
  
  if (skipProof) {
    uploadSection.style.display = 'none';
    confirmBtn.disabled = false;
    paymentProof = null;
  } else {
    uploadSection.style.display = 'block';
    confirmBtn.disabled = !paymentProof;
  }
}

function closePaymentProofPopup() {
  document.getElementById('paymentProofPopup').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function handlePopupProofUpload(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    if (!file.type.match('image.*')) {
      showNotification('❌ Please upload an image file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      showNotification('❌ Image must be less than 5MB');
      return;
    }
    
    paymentProof = file;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const preview = document.getElementById('popupProofPreview');
      preview.src = e.target.result;
      preview.classList.add('show');
      
      const uploadArea = document.getElementById('popupUploadArea');
      uploadArea.classList.add('has-file');
      uploadArea.querySelector('i').className = 'fas fa-check-circle';
      
      document.getElementById('confirmPaymentBtn').disabled = false;
    };
    reader.readAsDataURL(file);
  }
}

async function processPayment() {
  if (!customerInfo.name || !customerInfo.phone || !customerInfo.address) {
    showNotification('❌ Please complete customer information first');
    navigateTo('customerInfoPage');
    return;
  }
  
  if (cart.length === 0) {
    showNotification('❌ Your cart is empty');
    navigateTo('productsPage');
    return;
  }
  
  if (selectedPaymentMethod !== 'cod') {
    showPaymentProofPopup(selectedPaymentMethod);
    return;
  }
  
  completeOrder();
}

async function confirmPaymentWithProof() {
  closePaymentProofPopup();
  await completeOrder();
}

// ===== COMPLETE ORDER FUNCTION =====
async function completeOrder() {
  let subtotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  let deliveryCharge = 0;
  if (customerInfo.address) {
    const addressLower = customerInfo.address.toLowerCase();
    if (addressLower.includes('karachi') || addressLower.includes('lahore') || addressLower.includes('islamabad')) {
      deliveryCharge = 150;
    } else {
      deliveryCharge = 300;
    }
  }
  
  const total = subtotal + deliveryCharge;
  
  const orderId = 'ORD-' + Date.now().toString().slice(-8);
  const token = generateOrderToken();
  
  const orderItems = cart.map(item => ({
    title: item.title,
    price: parseFloat(item.discountPrice || item.originalPrice || 0),
    quantity: item.quantity || 1,
    image: item.image || ''
  }));
  
  pendingOrder = {
    orderId: orderId,
    token: token,
    customerName: customerInfo.name,
    customerPhone: customerInfo.phone,
    customerEmail: customerInfo.email,
    customerAddress: customerInfo.address,
    customerLocation: customerInfo.location,
    items: orderItems,
    subtotal: subtotal,
    deliveryCharge: deliveryCharge,
    total: total,
    paymentMethod: selectedPaymentMethod,
    paymentProof: paymentProof ? 'uploaded' : (skipProof ? 'details_only' : null),
    status: 'pending',
    created_at: new Date().toISOString()
  };
  
  console.log('📦 Pending order:', pendingOrder);
  
  const saved = await saveOrderToDatabase(pendingOrder);
  
  if (saved) {
    console.log('✅ Order saved to database');
    
    sendOrderToBusinessWhatsApp(pendingOrder);
    
    orders.unshift(pendingOrder);
    orderTokens.unshift({
      id: token,
      orderId: orderId,
      amount: total,
      status: 'pending',
      customer: customerInfo.name,
      date: pendingOrder.created_at
    });
    
    cart = [];
    updateCartCount();
    isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
    
    showOrderConfirmation(pendingOrder);
    navigateTo('deliveryPage');
    
    addInnerNotification('Order Placed', `Order #${orderId} awaiting confirmation`, 'success');
  } else {
    showNotification('❌ Failed to save order. Please try again.');
  }
}

// ===== SAVE ORDER TO DATABASE =====
async function saveOrderToDatabase(orderData) {
  try {
    if (!currentBusinessId) {
      console.error('❌ No business ID found');
      showNotification('❌ Business ID not found');
      return false;
    }
    
    console.log('📤 Saving order for business:', currentBusinessId);
    
    const orderToInsert = {
      business_id: currentBusinessId,
      order_id: orderData.orderId,
      token: orderData.token,
      customer_name: orderData.customerName || null,
      customer_phone: orderData.customerPhone || '',
      customer_address: orderData.customerAddress || '',
      items: orderData.items || [],
      subtotal: orderData.subtotal || 0,
      delivery_charge: orderData.deliveryCharge || 0,
      total: orderData.total || 0,
      payment_method: orderData.paymentMethod || 'cod',
      status: 'pending',
      zone: null,
      estimated_delivery: null,
      notes: null,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    if (orderData.customerEmail) {
      orderToInsert.customer_email = orderData.customerEmail;
    }
    
    if (orderData.customerLocation && orderData.customerLocation.lat) {
      orderToInsert.customer_location = orderData.customerLocation;
    }
    
    if (orderData.paymentProof) {
      orderToInsert.payment_proof = orderData.paymentProof;
    }
    
    console.log('📦 Inserting order:', orderToInsert);
    
    const { data, error } = await supa
      .from('orders')
      .insert([orderToInsert])
      .select();
    
    if (error) {
      console.error('❌ Supabase error:', error);
      showNotification('❌ Database error: ' + error.message);
      return false;
    }
    
    console.log('✅ Order saved successfully:', data);
    showNotification('✅ Order placed successfully!');
    
    if (isAdminLoggedIn) {
      setTimeout(() => {
        loadOrdersFromDatabase();
      }, 1000);
    }
    
    return true;
    
  } catch (error) {
    console.error('❌ Exception:', error);
    showNotification('❌ Error: ' + error.message);
    return false;
  }
}

// ===== LOAD ORDERS FROM DATABASE =====
async function loadOrdersFromDatabase() {
  try {
    if (!currentBusinessId) {
      console.error('❌ No business ID');
      return [];
    }
    
    console.log('📥 Loading orders for business:', currentBusinessId);
    
    const { data, error } = await supa
      .from('orders')
      .select('*')
      .eq('business_id', currentBusinessId)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('❌ Error loading orders:', error);
      showNotification('❌ Error loading orders');
      return [];
    }
    
    if (data && data.length > 0) {
      console.log(`✅ Loaded ${data.length} orders`);
      
      orders = data;
      orderTokens = data.map(order => ({
        id: order.token,
        orderId: order.order_id,
        amount: order.total,
        status: order.status,
        customer: order.customer_name,
        date: order.created_at
      }));
      
      updateTokenStats();
      
      if (isAdminLoggedIn && currentPage === 'adminPage') {
        renderTokenList();
      }
      
      checkForDeliveries();
      
    } else {
      console.log('📭 No orders found');
      orders = [];
      orderTokens = [];
      if (isAdminLoggedIn && currentPage === 'adminPage') {
        renderTokenList();
      }
    }
    
    return data;
    
  } catch (error) {
    console.error('❌ Exception loading orders:', error);
    return [];
  }
}

// ===== SETUP REAL-TIME SUBSCRIPTION =====
function setupOrdersSubscription() {
  if (!currentBusinessId) {
    console.log('⏳ Waiting for business ID...');
    return;
  }
  
  if (ordersSubscription) {
    ordersSubscription.unsubscribe();
  }
  
  console.log('🔄 Setting up real-time subscription...');
  
  ordersSubscription = supa
    .channel(`orders-${currentBusinessId}`)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'orders',
        filter: `business_id=eq.${currentBusinessId}`
      },
      (payload) => {
        console.log('⚡ Real-time order update:', payload);
        
        if (payload.eventType === 'INSERT') {
          showNotification('🆕 New order received!');
          addInnerNotification('New Order', `Order ${payload.new.order_id} received`, 'success');
        }
        
        loadOrdersFromDatabase();
      }
    )
    .subscribe();
}

// ===== SEND ORDER TO BUSINESS WHATSAPP =====
function sendOrderToBusinessWhatsApp(order) {
  try {
    if (card.phone) {
      const phone = card.phone.replace(/\D/g, '');
      
      let message = `🛍️ *NEW ORDER RECEIVED*\n\n`;
      message += `*Order ID:* ${order.orderId}\n`;
      message += `*Token:* ${order.token}\n`;
      message += `*Customer:* ${order.customerName}\n`;
      message += `*Phone:* ${order.customerPhone}\n`;
      message += `*Address:* ${order.customerAddress}\n`;
      message += `\n*Items:*\n`;
      
      order.items.forEach(item => {
        message += `• ${item.title} x${item.quantity} - PKR ${(item.price * item.quantity).toFixed(2)}\n`;
      });
      
      message += `\n*Subtotal:* PKR ${order.subtotal.toFixed(2)}`;
      message += `\n*Delivery:* PKR ${order.deliveryCharge.toFixed(2)}`;
      message += `\n*Total:* PKR ${order.total.toFixed(2)}`;
      message += `\n*Payment Method:* ${getPaymentMethodName(order.paymentMethod)}`;
      message += `\n*Proof Status:* ${order.paymentProof === 'uploaded' ? '✅ Screenshot uploaded' : '📝 Transaction details to be sent'}`;
      message += `\n*Status:* Pending Confirmation`;
      
      if (order.paymentProof === 'uploaded') {
        message += `\n\n⚠️ *IMPORTANT:* Customer has uploaded payment proof screenshot. Please check.`;
      }
      
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
      showNotification('📱 WhatsApp opened - send message to business');
    }
  } catch (error) {
    console.error('Error sending WhatsApp:', error);
  }
}

function getPaymentMethodName(method) {
  const names = { 
    'cod': 'Cash on Delivery', 
    'jazzcash': 'JazzCash', 
    'easypaisa': 'EasyPaisa', 
    'bank': 'Bank Transfer', 
    'card': 'Card Payment', 
    'crypto': 'Cryptocurrency'
  };
  return names[method] || method;
}

function completePaymentAndConfirmOrder() {
  closeModal('paymentDetailsModal');
  processPayment();
}

// ===== ORDER TOKEN GENERATION =====
function generateOrderToken() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const prefix = card.tokenSystem?.prefix || 'TKT';
  const timestamp = Date.now().toString().slice(-6);
  let random = '';
  for (let i = 0; i < 4; i++) random += chars.charAt(Math.floor(Math.random() * chars.length));
  return `${prefix}-${timestamp}-${random}`;
}

// ===== MODAL FUNCTIONS =====
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

function closeDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'none';
}

// ===== PRODUCT ZOOM FUNCTIONS =====
function zoomProductImage(imageUrl, event) {
  if (event) event.stopPropagation();
  if (imageUrl) {
    document.getElementById('zoomedProductImage').src = imageUrl;
    document.getElementById('productZoomOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeProductZoom() {
  document.getElementById('productZoomOverlay').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ===== RECEIPT FUNCTIONS =====
function showReceipt(order) {
  const receiptModal = document.getElementById('receiptModal');
  const receiptDetails = document.getElementById('receiptDetails');
  
  const date = new Date().toLocaleString();
  
  receiptDetails.innerHTML = `
    <div class="receipt-row">
      <span class="receipt-label">Order ID</span>
      <span class="receipt-value">${order.order_id}</span>
    </div>
    <div class="receipt-row">
      <span class="receipt-label">Token</span>
      <span class="receipt-value" style="color:#667eea;">${order.token}</span>
    </div>
    <div class="receipt-row">
      <span class="receipt-label">Date</span>
      <span class="receipt-value">${date}</span>
    </div>
    <div class="receipt-row">
      <span class="receipt-label">Customer</span>
      <span class="receipt-value">${order.customer_name}</span>
    </div>
    <div class="receipt-row">
      <span class="receipt-label">Items</span>
      <span class="receipt-value">${order.items.length}</span>
    </div>
    <div class="receipt-row" style="border-top:2px dashed #e2e8f0; padding-top:12px;">
      <span class="receipt-label" style="font-size:16px;">Total</span>
      <span class="receipt-value receipt-total">PKR ${order.total.toFixed(2)}</span>
    </div>
  `;
  
  window.currentReceiptOrder = order;
  
  receiptModal.style.display = 'flex';
}

function closeReceiptModal() {
  document.getElementById('receiptModal').style.display = 'none';
}

function sendReceiptToWhatsApp() {
  const order = window.currentReceiptOrder;
  if (!order || !order.customer_phone) {
    showNotification('❌ No phone number available');
    return;
  }
  
  const phone = order.customer_phone.replace(/\D/g, '');
  
  let message = `🧾 *ORDER CONFIRMATION RECEIPT*\n\n`;
  message += `✅ Your order has been confirmed!\n\n`;
  message += `*Order ID:* ${order.order_id}\n`;
  message += `*Token:* ${order.token}\n`;
  message += `*Date:* ${new Date().toLocaleString()}\n\n`;
  message += `*Items:*\n`;
  
  order.items.forEach(item => {
    message += `• ${item.title} x${item.quantity} - PKR ${(item.price * item.quantity).toFixed(2)}\n`;
  });
  
  message += `\n*Total Amount:* PKR ${order.total.toFixed(2)}`;
  message += `\n*Payment Method:* ${getPaymentMethodName(order.payment_method)}`;
  message += `\n\nThank you for your order! 🎉`;
  
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  
  closeReceiptModal();
}

function sendReceiptToEmail() {
  const order = window.currentReceiptOrder;
  if (!order || !order.customer_email) {
    showNotification('❌ No email address available');
    return;
  }
  
  const subject = `Order Confirmation - ${order.order_id}`;
  let body = `ORDER CONFIRMATION RECEIPT\n\n`;
  body += `Your order has been confirmed!\n\n`;
  body += `Order ID: ${order.order_id}\n`;
  body += `Token: ${order.token}\n`;
  body += `Date: ${new Date().toLocaleString()}\n\n`;
  body += `Items:\n`;
  
  order.items.forEach(item => {
    body += `- ${item.title} x${item.quantity}: PKR ${(item.price * item.quantity).toFixed(2)}\n`;
  });
  
  body += `\nTotal Amount: PKR ${order.total.toFixed(2)}`;
  body += `\nPayment Method: ${getPaymentMethodName(order.payment_method)}`;
  body += `\n\nThank you for your order!`;
  
  window.open(`mailto:${order.customer_email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
  
  closeReceiptModal();
}

function downloadReceipt() {
  const order = window.currentReceiptOrder;
  if (!order) return;
  
  const receiptText = `ORDER CONFIRMATION RECEIPT
========================
Order ID: ${order.order_id}
Token: ${order.token}
Date: ${new Date().toLocaleString()}
Customer: ${order.customer_name}
Phone: ${order.customer_phone}
Email: ${order.customer_email || 'N/A'}

ITEMS:
${order.items.map(item => `- ${item.title} x${item.quantity}: PKR ${(item.price * item.quantity).toFixed(2)}`).join('\n')}

Subtotal: PKR ${order.subtotal.toFixed(2)}
Delivery: PKR ${order.delivery_charge.toFixed(2)}
Total: PKR ${order.total.toFixed(2)}
Payment Method: ${getPaymentMethodName(order.payment_method)}

Thank you for your order!`;
  
  const blob = new Blob([receiptText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `receipt-${order.order_id}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message) {
  const notification = document.getElementById('notificationAlert');
  notification.textContent = message;
  notification.style.display = 'block';
  setTimeout(() => { notification.style.display = 'none'; }, 3000);
}

function addInnerNotification(title, message, type = 'info') {
  const notification = {
    id: Date.now(),
    title,
    message,
    type,
    time: new Date(),
    read: false
  };
  
  innerNotifications.unshift(notification);
  unreadNotifications++;
  
  if (innerNotifications.length > 50) innerNotifications.pop();
  
  isolatedLocalStorage.setItem('innerNotifications', JSON.stringify(innerNotifications));
  updateNotificationBellCount();
}

function updateNotificationBellCount() {
  const badge = document.getElementById('notificationBadge');
  const bell = document.getElementById('notificationBell');
  
  if (unreadNotifications > 0) {
    badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
    badge.style.display = 'flex';
    bell.style.color = '#f59e0b';
  } else {
    badge.style.display = 'none';
    bell.style.color = 'white';
  }
}

function toggleNotificationDrawer() {
  const drawer = document.getElementById('notificationDrawer');
  drawer.classList.toggle('open');
  if (drawer.classList.contains('open')) loadNotificationDrawer();
}

function loadNotificationDrawer() {
  const list = document.getElementById('notificationList');
  const count = document.getElementById('notificationCount');
  
  if (innerNotifications.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fas fa-bell-slash" style="font-size:60px; color:#cbd5e1;"></i><h3 style="margin-top:16px; color:#1e293b;">No notifications</h3></div>`;
    count.textContent = '0';
    return;
  }
  
  let html = '';
  innerNotifications.slice(0, 20).forEach(notif => {
    html += `
      <div class="notification-item" onclick="markNotificationRead('${notif.id}')" style="padding:16px; background:white; border-radius:12px; margin-bottom:8px; border-left:4px solid ${notif.read ? '#cbd5e1' : '#667eea'}; cursor:pointer;">
        <div style="display:flex; align-items:start; gap:12px;">
          <div style="font-size:20px;">${notif.type === 'success' ? '✅' : notif.type === 'error' ? '❌' : 'ℹ️'}</div>
          <div style="flex:1;">
            <div style="font-weight:800; color:var(--dark-color); font-size:14px;">${notif.title}</div>
            <div style="color:#64748b; font-size:13px; margin-top:4px;">${notif.message}</div>
            <div style="font-size:11px; color:#94a3b8; margin-top:6px;">${new Date(notif.time).toLocaleTimeString()}</div>
          </div>
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
  count.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
}

function markNotificationRead(id) {
  const notif = innerNotifications.find(n => n.id == id);
  if (notif && !notif.read) {
    notif.read = true;
    unreadNotifications--;
    isolatedLocalStorage.setItem('innerNotifications', JSON.stringify(innerNotifications));
    updateNotificationBellCount();
    loadNotificationDrawer();
  }
}

function markAllNotificationsAsRead() {
  innerNotifications.forEach(n => n.read = true);
  unreadNotifications = 0;
  isolatedLocalStorage.setItem('innerNotifications', JSON.stringify(innerNotifications));
  updateNotificationBellCount();
  loadNotificationDrawer();
  showNotification('✅ All notifications marked as read');
}

// ===== NOTIFICATION PERMISSION =====
async function enableNotifications() {
  if (!('Notification' in window)) {
    showNotification('❌ Notifications not supported');
    return;
  }
  
  if (Notification.permission === 'granted') {
    showNotification('✅ Notifications already enabled!');
  } else if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      showNotification('✅ Notifications enabled!');
      addInnerNotification('Notifications Enabled', 'You will receive alerts for updates', 'success');
    }
  }
}

// ===== SERVICE WORKER =====
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('sw.js');
      console.log('Service Worker registered:', registration);
    } catch (error) {
      console.error('Service Worker registration failed:', error);
    }
  }
}

// ===== PWA SETUP =====
function setupDynamicPWA(businessData) {
  const businessName = businessData.businessName || businessData.name || "Digital Business";
  document.title = businessName;
  
  const titleEl = document.getElementById('loadingTitle');
  const subtitleEl = document.getElementById('loadingSubtitle');
  if (titleEl) titleEl.textContent = businessName;
  if (subtitleEl) subtitleEl.textContent = `Loading ${businessName} experience...`;
  
  document.getElementById('themeColorMeta').content = "#667eea";
  
  updateFavicon(businessData.profileImage || getDefaultIcon(businessName));
  setupManifest(businessData, businessName);
}

function getDefaultIcon(businessName) {
  const firstLetter = businessName.charAt(0).toUpperCase();
  const colors = ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
  const color = colors[businessName.length % colors.length];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100"><rect width="100" height="100" fill="${color}" rx="20"/><text x="50" y="65" font-size="40" font-family="Arial, sans-serif" fill="white" text-anchor="middle" font-weight="bold">${firstLetter}</text></svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}

function updateFavicon(iconUrl) {
  let favicon = document.querySelector('link[rel="icon"]');
  if (!favicon) {
    favicon = document.createElement('link');
    favicon.rel = 'icon';
    document.head.appendChild(favicon);
  }
  favicon.href = iconUrl;
  
  let appleIcon = document.querySelector('link[rel="apple-touch-icon"]');
  if (!appleIcon) {
    appleIcon = document.createElement('link');
    appleIcon.rel = 'apple-touch-icon';
    document.head.appendChild(appleIcon);
  }
  appleIcon.href = iconUrl;
  appleIcon.sizes = "180x180";
}

function setupManifest(businessData, businessName) {
  const profileImage = businessData.profileImage || getDefaultIcon(businessName);
  const baseUrl = window.location.origin + window.location.pathname;
  
  const manifest = {
    name: businessName,
    short_name: businessName.length > 12 ? businessName.substring(0, 10) + '…' : businessName,
    description: `Premium business app for ${businessName}`,
    theme_color: "#667eea",
    background_color: "#ffffff",
    display: "standalone",
    orientation: "portrait",
    scope: "/",
    start_url: baseUrl + "?source=pwa",
    icons: [
      {
        src: profileImage,
        sizes: "192x192",
        type: "image/png",
        purpose: "any maskable"
      },
      {
        src: profileImage,
        sizes: "512x512",
        type: "image/png",
        purpose: "any maskable"
      }
    ]
  };
  
  const manifestData = JSON.stringify(manifest, null, 2);
  const blob = new Blob([manifestData], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(blob);
  
  const manifestLink = document.getElementById('manifestLink');
  if (manifestLink) {
    manifestLink.href = manifestURL;
  }
  
  localStorage.setItem('pwa_manifest', manifestData);
  console.log('PWA Manifest updated for:', businessName);
}

// ===== PWA INSTALL =====
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (!installButtonShown) {
    setTimeout(() => showInstallButton(), 5000);
    installButtonShown = true;
  }
});

function showInstallButton() {
  if (!deferredPrompt) return;
  
  const existing = document.querySelector('.install-button-container');
  if (existing) existing.remove();
  
  const container = document.createElement('div');
  container.className = 'install-button-container';
  container.innerHTML = `
    <button class="install-btn" onclick="installPWA()">
      <i class="fas fa-download"></i> Install App
    </button>
  `;
  document.body.appendChild(container);
  
  setTimeout(() => {
    if (container.parentNode) {
      container.remove();
      installButtonShown = false;
    }
  }, 30000);
}

function installPWA() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(() => {
    deferredPrompt = null;
    const container = document.querySelector('.install-button-container');
    if (container) container.remove();
  });
}

function isPWAInstalled() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}

// ===== SHARE BUSINESS =====
function shareBusiness() {
  const businessName = card.businessName || card.name || "Business";
  const currentUrl = window.location.href.split('?')[0];
  let shareUrl = currentUrl + "?id=" + currentBusinessId;
  const shareText = `Check out ${businessName} on their business app!\n\n${shareUrl}`;
  
  if (navigator.share) {
    navigator.share({ title: businessName, text: shareText, url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareText);
    showNotification('📋 Link copied to clipboard!');
  }
}

// ===== DELIVERY STATUS =====
async function checkForDeliveries() {
  if (!customerInfo.phone) return;
  
  const customerOrders = orders.filter(order => 
    order.customer_phone === customerInfo.phone || order.customerPhone === customerInfo.phone
  );
  
  deliveryStatusData = customerOrders;
  updateDeliveryIcon();
}

function updateDeliveryIcon() {
  const icon = document.getElementById('deliveryIcon');
  const badge = document.getElementById('deliveryBadge');
  
  if (deliveryStatusData.length > 0) {
    icon.style.color = '#10b981';
    badge.textContent = deliveryStatusData.length;
    badge.style.display = 'flex';
    const hasPending = deliveryStatusData.some(order => 
      ['pending', 'confirmed', 'processing', 'shipped'].includes(order.status)
    );
    if (hasPending) badge.classList.add('alert');
    else badge.classList.remove('alert');
  } else {
    icon.style.color = 'white';
    badge.style.display = 'none';
    badge.classList.remove('alert');
  }
}

async function loadDeliveryStatus() {
  const content = document.getElementById('deliveryContent');
  
  if (!customerInfo.phone) {
    content.innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-phone" style="font-size:48px; color:#cbd5e1; margin-bottom:16px;"></i>
        <h3 style="color:#1e293b; margin-bottom:12px;">Phone Number Needed</h3>
        <p style="color:#64748b; margin-bottom:24px;">Please save your phone number to track orders.</p>
        <button onclick="window.navigateTo('customerInfoPage')" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
          Add Phone Number
        </button>
      </div>
    `;
    return;
  }
  
  const customerOrders = orders.filter(order => 
    order.customer_phone === customerInfo.phone || order.customerPhone === customerInfo.phone
  );
  
  if (customerOrders.length === 0) {
    content.innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-truck" style="font-size:48px; color:#10b981; margin-bottom:16px;"></i>
        <h3 style="color:#1e293b; margin-bottom:12px;">No Orders Yet</h3>
        <p style="color:#64748b; margin-bottom:24px;">Your orders will appear here once you place them.</p>
        <button onclick="window.navigateTo('productsPage')" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
          <i class="fas fa-shopping-bag"></i> Shop Now
        </button>
      </div>
    `;
    return;
  }
  
  let html = '';
  customerOrders.forEach(order => {
    const statusConfig = {
      'pending': { color: '#f59e0b', text: '⏳ Pending' },
      'confirmed': { color: '#3b82f6', text: '✅ Confirmed' },
      'processing': { color: '#8b5cf6', text: '🔄 Processing' },
      'shipped': { color: '#10b981', text: '🚚 Shipped' },
      'delivered': { color: '#059669', text: '📦 Delivered' },
      'cancelled': { color: '#ef4444', text: '❌ Cancelled' },
      'refused': { color: '#64748b', text: '❌ Refused' }
    };
    
    const status = statusConfig[order.status] || { color: '#64748b', text: order.status };
    const date = new Date(order.created_at).toLocaleDateString();
    
    html += `
      <div class="order-card" style="border-left-color: ${status.color};">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <span style="font-weight:800; color:${status.color};">${status.text}</span>
          <span style="font-size:12px; color:#64748b;">${date}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span style="font-weight:700;">Token:</span>
          <span style="font-weight:800; color:#667eea;">${order.token}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>Order ID:</span>
          <span style="font-size:13px;">${order.order_id}</span>
        </div>
        <div style="margin:12px 0; padding:12px 0; border-top:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0;">
          ${order.items.map(item => `
            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
              <span>${item.title} x${item.quantity}</span>
              <span>PKR ${(item.price * item.quantity).toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <div style="display:flex; justify-content:space-between; font-weight:800;">
          <span>Total:</span>
          <span style="color:#10b981;">PKR ${order.total.toFixed(2)}</span>
        </div>
        <div style="margin-top:12px; font-size:11px; color:#64748b;">
          <i class="fas fa-credit-card"></i> ${getPaymentMethodName(order.payment_method)}
        </div>
      </div>
    `;
  });
  
  content.innerHTML = html;
}

// ===== RENDER TOKEN LIST =====
function renderTokenList() {
  const tokenList = document.getElementById('tokenList');
  if (!tokenList) return;
  
  if (orderTokens.length === 0) {
    tokenList.innerHTML = `
      <div style="text-align:center; padding:40px;">
        <i class="fas fa-ticket-alt" style="font-size:48px; color:#cbd5e1;"></i>
        <p style="color:#64748b; margin-top:16px;">No orders yet</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  orderTokens.slice(0, 30).forEach(token => {
    const date = new Date(token.date).toLocaleString();
    const statusColor = 
      token.status === 'delivered' ? '#10b981' : 
      token.status === 'cancelled' ? '#ef4444' : 
      token.status === 'refused' ? '#64748b' :
      token.status === 'pending' ? '#f59e0b' :
      token.status === 'confirmed' ? '#3b82f6' : 
      token.status === 'processing' ? '#8b5cf6' :
      token.status === 'shipped' ? '#10b981' : '#64748b';
    
    html += `
      <div class="token-item" onclick="window.viewOrderDetails('${token.orderId}')" 
           style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #e2e8f0; cursor:pointer;">
        <div>
          <div style="font-weight:800; color:#667eea;">${token.id}</div>
          <div style="font-size:11px; color:#64748b; margin-top:4px;">
            ${token.orderId} • ${date}
          </div>
          <div style="font-size:12px; color:#475569; margin-top:2px;">
            👤 ${token.customer || 'Customer'}
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700; color:#10b981;">PKR ${token.amount.toFixed(2)}</div>
          <span style="display:inline-block; padding:4px 8px; border-radius:4px; font-size:11px; 
                       background: ${statusColor}20; color: ${statusColor}; margin-top:4px;">
            ${token.status.replace('_', ' ')}
          </span>
        </div>
      </div>
    `;
  });
  
  tokenList.innerHTML = html;
}

function updateTokenStats() {
  const totalEl = document.getElementById('totalTokensCount');
  const activeEl = document.getElementById('activeTokensCount');
  const todayEl = document.getElementById('todayTokensCount');
  
  if (totalEl) totalEl.textContent = orderTokens.length;
  
  const activeTokens = orderTokens.filter(t => 
    ['pending', 'confirmed', 'processing', 'shipped'].includes(t.status)
  ).length;
  if (activeEl) activeEl.textContent = activeTokens;
  
  const today = new Date().toDateString();
  const todayTokens = orderTokens.filter(t => new Date(t.date).toDateString() === today).length;
  if (todayEl) todayEl.textContent = todayTokens;
}

function searchAdminTokens() {
  const searchTerm = document.getElementById('adminTokenSearch').value.toLowerCase();
  const filtered = orderTokens.filter(token => 
    token.id.toLowerCase().includes(searchTerm) ||
    token.orderId.toLowerCase().includes(searchTerm) ||
    (token.customer && token.customer.toLowerCase().includes(searchTerm)) ||
    token.amount.toString().includes(searchTerm)
  );
  
  const tokenList = document.getElementById('tokenList');
  if (filtered.length === 0) {
    tokenList.innerHTML = '<p style="text-align:center; padding:20px; color:#64748b;">No matching orders found</p>';
    return;
  }
  
  let html = '';
  filtered.slice(0, 30).forEach(token => {
    const date = new Date(token.date).toLocaleDateString();
    const statusColor = 
      token.status === 'delivered' ? '#10b981' : 
      token.status === 'cancelled' ? '#ef4444' : 
      token.status === 'refused' ? '#64748b' :
      token.status === 'pending' ? '#f59e0b' :
      token.status === 'confirmed' ? '#3b82f6' : 
      token.status === 'processing' ? '#8b5cf6' :
      token.status === 'shipped' ? '#10b981' : '#64748b';
    
    html += `
      <div class="token-item" onclick="window.viewOrderDetails('${token.orderId}')">
        <div>
          <div class="token-code">${token.id}</div>
          <div style="font-size:11px; color:#64748b; margin-top:4px;">${token.orderId} • ${date}</div>
          <div style="font-size:11px; color:#475569; margin-top:2px;">👤 ${token.customer || 'Customer'}</div>
        </div>
        <div style="text-align:right;">
          <div class="token-amount">PKR ${token.amount.toFixed(2)}</div>
          <span class="token-status" style="background: ${statusColor}20; color: ${statusColor};">${token.status.replace('_', ' ')}</span>
        </div>
      </div>
    `;
  });
  
  tokenList.innerHTML = html;
}

function filterPendingOrders() {
  const filtered = orderTokens.filter(t => t.status === 'pending');
  const tokenList = document.getElementById('tokenList');
  
  if (filtered.length === 0) {
    tokenList.innerHTML = '<p style="text-align:center; padding:20px;">No pending orders</p>';
    return;
  }
  
  let html = '';
  filtered.forEach(token => {
    const date = new Date(token.date).toLocaleString();
    html += `
      <div class="token-item" onclick="window.viewOrderDetails('${token.orderId}')">
        <div>
          <div style="font-weight:800; color:#667eea;">${token.id}</div>
          <div style="font-size:11px; color:#64748b;">${token.orderId} • ${date}</div>
          <div>👤 ${token.customer}</div>
        </div>
        <div>
          <div style="font-weight:700; color:#10b981;">PKR ${token.amount.toFixed(2)}</div>
          <span style="color:#f59e0b;">⏳ Pending</span>
        </div>
      </div>
    `;
  });
  tokenList.innerHTML = html;
}

function filterConfirmedOrders() {
  const filtered = orderTokens.filter(t => ['confirmed', 'processing', 'shipped'].includes(t.status));
  const tokenList = document.getElementById('tokenList');
  
  if (filtered.length === 0) {
    tokenList.innerHTML = '<p style="text-align:center; padding:20px;">No confirmed orders</p>';
    return;
  }
  
  let html = '';
  filtered.forEach(token => {
    const date = new Date(token.date).toLocaleString();
    const statusColor = token.status === 'confirmed' ? '#3b82f6' : token.status === 'processing' ? '#8b5cf6' : '#10b981';
    html += `
      <div class="token-item" onclick="window.viewOrderDetails('${token.orderId}')">
        <div>
          <div style="font-weight:800; color:#667eea;">${token.id}</div>
          <div style="font-size:11px; color:#64748b;">${token.orderId} • ${date}</div>
          <div>👤 ${token.customer}</div>
        </div>
        <div>
          <div style="font-weight:700; color:#10b981;">PKR ${token.amount.toFixed(2)}</div>
          <span style="color:${statusColor};">${token.status}</span>
        </div>
      </div>
    `;
  });
  tokenList.innerHTML = html;
}

function filterAllOrders() {
  renderTokenList();
}

function refreshOrders() {
  showNotification('🔄 Refreshing orders...');
  loadOrdersFromDatabase();
}

async function viewOrderDetails(orderId) {
  const order = orders.find(o => o.order_id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('orderConfirmationModal');
  const content = document.getElementById('orderConfirmationContent');
  
  const date = new Date(order.created_at).toLocaleString();
  let itemsHtml = '';
  if (order.items && Array.isArray(order.items)) {
    order.items.forEach(item => {
      itemsHtml += `
        <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:13px;">
          <span>${item.title} x${item.quantity}</span>
          <span>PKR ${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `;
    });
  }
  
  const locationLink = order.customer_location && order.customer_location.lat ? 
    `<a href="https://maps.google.com/?q=${order.customer_location.lat},${order.customer_location.lng}" target="_blank" style="color:#667eea;">📍 View on Map</a>` : '';
  
  const confirmButton = order.status === 'pending' && isAdminLoggedIn ? 
    `<button class="admin-confirm-btn" onclick="confirmOrder('${order.id}')">
       <i class="fas fa-check-circle"></i> Confirm Order
     </button>` : '';
  
  const proofStatus = order.payment_proof === 'uploaded' ? 
    '<span style="color:#10b981;"><i class="fas fa-check-circle"></i> Proof Uploaded</span>' : 
    '<span style="color:#f59e0b;"><i class="fas fa-info-circle"></i> Proof Not Uploaded</span>';
  
  const statusColors = {
    'pending': '#f59e0b',
    'confirmed': '#3b82f6',
    'processing': '#8b5cf6',
    'shipped': '#10b981',
    'delivered': '#059669',
    'cancelled': '#ef4444',
    'refused': '#64748b'
  };
  
  content.innerHTML = `
    <div class="order-ticket">
      <div class="ticket-header">
        <span class="ticket-id">${order.token}</span>
        <span class="ticket-date">${date}</span>
      </div>
      <div class="ticket-body">
        <div style="text-align:center; margin-bottom:20px;">
          <h3 style="color:white; margin-top:12px;">Order Details</h3>
          <div style="font-size:12px; margin-top:8px;">${proofStatus}</div>
        </div>
        
        <div class="ticket-row">
          <span>Order ID:</span>
          <span style="font-weight:800;">${order.order_id}</span>
        </div>
        <div class="ticket-row">
          <span>Customer:</span>
          <span>${order.customer_name}</span>
        </div>
        <div class="ticket-row">
          <span>Phone:</span>
          <span>${order.customer_phone}</span>
        </div>
        ${order.customer_email ? `
        <div class="ticket-row">
          <span>Email:</span>
          <span>${order.customer_email}</span>
        </div>
        ` : ''}
        <div class="ticket-row">
          <span>Address:</span>
          <span style="max-width:180px;">${order.customer_address}</span>
        </div>
        ${locationLink ? `
        <div class="ticket-row">
          <span>Location:</span>
          <span>${locationLink}</span>
        </div>
        ` : ''}
        
        <div style="margin:16px 0; padding:12px 0; border-top:2px dashed rgba(255,255,255,0.3); border-bottom:2px dashed rgba(255,255,255,0.3);">
          ${itemsHtml}
        </div>
        
        <div class="ticket-row">
          <span>Subtotal:</span>
          <span>PKR ${order.subtotal.toFixed(2)}</span>
        </div>
        <div class="ticket-row">
          <span>Delivery:</span>
          <span>PKR ${order.delivery_charge.toFixed(2)}</span>
        </div>
        <div class="ticket-total">
          <span>Total</span>
          <span>PKR ${order.total.toFixed(2)}</span>
        </div>
      </div>
      <div style="text-align:center; margin-top:20px; font-size:12px; opacity:0.9;">
        <i class="fas fa-shield-alt"></i> Payment: ${getPaymentMethodName(order.payment_method)}
      </div>
    </div>
    
    ${confirmButton}
    
    <div style="display:flex; gap:12px; margin-top:20px; flex-wrap:wrap;">
      <select id="orderStatusSelect" style="flex:2; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;">
        ${Object.keys(statusColors).map(status => `
          <option value="${status}" ${order.status === status ? 'selected' : ''}>
            ${status.toUpperCase()}
          </option>
        `).join('')}
      </select>
      <button onclick="window.updateOrderStatus('${order.id}')" 
        style="flex:1; padding:12px; background:var(--success-gradient); color:white; border:none; border-radius:8px; font-weight:700;">
        Update
      </button>
    </div>
    
    <div style="margin-top:16px; background:#fef3c7; padding:16px; border-radius:12px;">
      <div style="display:flex; align-items:center; gap:8px; color:#92400e; margin-bottom:8px;">
        <i class="fas fa-truck"></i>
        <span style="font-weight:700;">Status</span>
      </div>
      <div style="font-size:13px; color:#b45309;">
        ${order.status === 'pending' ? '⏳ Order received, waiting for admin confirmation' :
          order.status === 'confirmed' ? '✅ Order confirmed' :
          order.status === 'processing' ? '🔄 Order being processed' :
          order.status === 'shipped' ? '🚚 Order shipped' :
          order.status === 'delivered' ? '📦 Order delivered' :
          order.status === 'cancelled' ? '❌ Order cancelled' :
          order.status === 'refused' ? '❌ Order refused' : ''}
      </div>
    </div>
  `;
  
  openModal('orderConfirmationModal');
}

function confirmOrder(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (order) {
    supa
      .from('orders')
      .update({ status: 'confirmed', updated_at: new Date().toISOString() })
      .eq('id', orderId)
      .then(() => {
        showNotification('✅ Order confirmed');
        closeModal('orderConfirmationModal');
        loadOrdersFromDatabase();
        showReceipt(order);
      });
  }
}

function generateNewToken() {
  if (!isAdminLoggedIn) {
    showNotification('❌ Admin login required');
    return;
  }
  
  const token = generateOrderToken();
  const orderId = 'ORD-' + Date.now().toString().slice(-8);
  
  orderTokens.unshift({
    id: token,
    orderId: orderId,
    amount: 0,
    status: 'pending',
    customer: 'Manual Entry',
    date: new Date().toISOString()
  });
  
  updateTokenStats();
  renderTokenList();
  showNotification('✅ New token generated: ' + token);
}

// ===== CART MANAGEMENT =====
function addToCart(productIndex) {
  const products = card.products || [];
  const product = products[productIndex];
  
  if (product) {
    const existingIndex = cart.findIndex(item => 
      item.title === product.title && 
      item.discountPrice === product.discountPrice
    );
    
    if (existingIndex === -1) {
      cart.push({ ...product, index: productIndex, quantity: 1 });
    } else {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    }
    updateCartCount();
    showNotification('✅ Product added to cart!');
    addInnerNotification('Cart Updated', `${product.title} added to cart`, 'success');
  }
}

function addToCartFromModal() {
  if (currentProduct) {
    const products = card.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    if (productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
    }
  }
}

function removeFromCart(index) {
  if (cart[index]) {
    const productName = cart[index].title;
    cart.splice(index, 1);
    updateCartCount();
    showNotification('🗑️ Product removed from cart');
    addInnerNotification('Cart Updated', `${productName} removed from cart`, 'info');
  }
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change);
    loadCartPage();
    updateCartCount();
  }
}

function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if (cart.length === 0) {
    cartContent.innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-shopping-cart" style="font-size:64px; color:#cbd5e1; margin-bottom:20px;"></i>
        <h3 style="color:#1e293b; margin-bottom:12px;">Your cart is empty</h3>
        <p style="color:#64748b; margin-bottom:24px;">Add some products to get started</p>
        <button onclick="window.navigateTo('productsPage')" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
          Browse Products
        </button>
      </div>
    `;
    cartItemsCount.textContent = '0 items';
    return;
  }
  
  let html = '<div style="margin-bottom:16px;">';
  let total = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    
    html += `
      <div style="display:flex; gap:12px; background:white; padding:16px; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm);">
        <img src="${item.image || ''}" style="width:80px; height:80px; object-fit:cover; border-radius:12px; background:#f1f5f9;" loading="lazy" onerror="this.style.display='none'">
        <div style="flex:1;">
          <div style="font-weight:700; color:var(--dark-color); margin-bottom:6px;">${item.title || 'Product'}</div>
          <div style="font-weight:800; color:#10b981; margin-bottom:8px;">PKR ${itemTotal.toFixed(2)}</div>
          <div style="display:flex; align-items:center; gap:12px;">
            <div style="display:flex; align-items:center; gap:8px; background:#f1f5f9; border-radius:8px; padding:4px;">
              <button onclick="window.updateQuantity(${index}, -1)" style="width:30px; height:30px; border:none; background:white; border-radius:6px; font-weight:700; cursor:pointer;">-</button>
              <span style="font-weight:700; min-width:20px; text-align:center;">${item.quantity || 1}</span>
              <button onclick="window.updateQuantity(${index}, 1)" style="width:30px; height:30px; border:none; background:white; border-radius:6px; font-weight:700; cursor:pointer;">+</button>
            </div>
            <button onclick="window.removeFromCart(${index})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:14px;">
              Remove
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  html += `
    <div style="background:white; border-radius:20px; padding:20px; margin:16px; box-shadow:var(--shadow-md);">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-receipt" style="color:#667eea;"></i> Order Summary
      </h3>
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <span style="color:#64748b;">Subtotal</span>
        <span style="font-weight:700; color:var(--dark-color);">PKR ${total.toFixed(2)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:24px; padding-top:12px; border-top:2px solid #e2e8f0;">
        <span style="font-size:16px; font-weight:800; color:var(--dark-color);">Total</span>
        <span style="font-size:20px; font-weight:900; color:#10b981;">PKR ${total.toFixed(2)}</span>
      </div>
      <button onclick="window.navigateTo('customerInfoPage')" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800; font-size:16px; cursor:pointer;">
        <i class="fas fa-arrow-right"></i> Proceed to Checkout
      </button>
    </div>
  `;
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

// ===== PRODUCT CARDS =====
function createProductCard(product, index) {
  const price = product.discountPrice || product.originalPrice;
  const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  let discountPercentage = '';
  if (hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    discountPercentage = `<span class="discount-badge" onclick="event.stopPropagation();"><i class="fas fa-tag"></i> -${discount}%</span>`;
  }
  
  let offerBadge = '';
  if (product.offerTag) {
    offerBadge = `<span class="offer-badge" onclick="event.stopPropagation();"><i class="fas fa-gift"></i> ${product.offerTag}</span>`;
  }
  
  let featureBadges = '';
  if (product.badges && product.badges.length > 0) {
    featureBadges = product.badges.slice(0, 1).map(badge => 
      `<span class="feature-badge" onclick="event.stopPropagation();">${badge}</span>`
    ).join('');
  }
  
  let priceHtml = '';
  if (price) {
    if (hasDiscount && originalPrice) {
      priceHtml = `
        <div class="price-badge-container">
          <span class="current-price">PKR ${price}</span>
          <span class="original-price">PKR ${originalPrice}</span>
        </div>
      `;
    } else {
      priceHtml = `
        <div class="price-badge-container">
          <span class="current-price">PKR ${price}</span>
        </div>
      `;
    }
  }
  
  const cardElement = document.createElement('div');
  cardElement.className = 'product-card';
  
  cardElement.innerHTML = `
    <div class="product-image-container">
      <img src="${product.image || ''}" class="product-image" loading="lazy" onerror="this.style.display='none'">
      
      <div class="badge-container">
        ${discountPercentage}
        ${offerBadge || featureBadges}
      </div>
    </div>
    
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      ${priceHtml}
      <div class="product-actions">
        <button class="btn-primary" onclick="window.addToCart(${index}); event.stopPropagation();">
          <i class="fas fa-cart-plus"></i> Add
        </button>
        <button class="btn-secondary" onclick="window.buyNow(${index}); event.stopPropagation();">
          <i class="fas fa-bolt"></i> Buy
        </button>
      </div>
    </div>
  `;
  
  cardElement.querySelector('.product-image-container').onclick = (e) => {
    e.stopPropagation();
    if (product.image) {
      zoomProductImage(product.image, e);
    }
  };
  
  cardElement.onclick = (e) => {
    if (!e.target.closest('button') && !e.target.closest('.badge-container')) {
      showProductModal(index);
    }
  };
  
  return cardElement;
}

function showProductModal(productIndex) {
  const products = card.products || [];
  currentProduct = products[productIndex];
  
  if (!currentProduct) return;
  
  const price = currentProduct.discountPrice || currentProduct.originalPrice;
  const originalPrice = currentProduct.originalPrice && currentProduct.discountPrice ? currentProduct.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  document.getElementById('modalImage').src = currentProduct.image || '';
  document.getElementById('modalTitle').textContent = currentProduct.title || 'Product';
  document.getElementById('modalDescription').textContent = currentProduct.desc || 'No description available';
  
  const modalPrice = document.getElementById('modalPrice');
  if (hasDiscount) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    modalPrice.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="text-decoration:line-through; color:#94a3b8; font-size:16px; font-weight:500;">PKR ${originalPrice}</div>
        <div style="color:#10b981; font-size:24px; font-weight:900;">PKR ${price}</div>
        <div style="background:var(--danger-gradient); color:white; padding:4px 8px; border-radius:4px; font-size:13px; font-weight:800;">${discount}% OFF</div>
      </div>
    `;
  } else {
    modalPrice.innerHTML = `<div style="color:#10b981; font-size:24px; font-weight:900;">PKR ${price || 'N/A'}</div>`;
  }
  
  openModal('productModal');
}

function zoomImage(imageUrl, event) {
  if (event) event.stopPropagation();
  if (imageUrl) {
    document.getElementById('zoomedImage').src = imageUrl;
    document.getElementById('imageZoomOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeImageZoom() {
  document.getElementById('imageZoomOverlay').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function filterProducts() {
  const searchTerm = document.getElementById('productsSearch').value.toLowerCase();
  const products = card.products || [];
  const allProducts = document.getElementById('allProducts');
  allProducts.innerHTML = '';
  
  products.filter(product => 
    product.title?.toLowerCase().includes(searchTerm) ||
    product.desc?.toLowerCase().includes(searchTerm)
  ).forEach((product, index) => {
    allProducts.appendChild(createProductCard(product, index));
  });
}

function buyNow(productIndex) {
  const product = card.products[productIndex];
  if (product) {
    cart = [{ ...product, quantity: 1 }];
    updateCartCount();
    navigateTo('customerInfoPage');
    loadCustomerInfo();
  }
}

function buyNowFromModal() {
  if (currentProduct) {
    cart = [{ ...currentProduct, quantity: 1 }];
    updateCartCount();
    closeModal('productModal');
    navigateTo('customerInfoPage');
    loadCustomerInfo();
  }
}

// ===== ORDER CONFIRMATION MODAL =====
function showOrderConfirmation(orderData) {
  const modal = document.getElementById('orderConfirmationModal');
  const content = document.getElementById('orderConfirmationContent');
  
  const date = new Date().toLocaleString();
  let itemsHtml = '';
  
  orderData.items.forEach(item => {
    itemsHtml += `
      <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:13px;">
        <span>${item.title} x${item.quantity}</span>
        <span>PKR ${(item.price * item.quantity).toFixed(2)}</span>
      </div>
    `;
  });
  
  const locationLink = orderData.customerLocation && orderData.customerLocation.lat ? 
    `<a href="https://maps.google.com/?q=${orderData.customerLocation.lat},${orderData.customerLocation.lng}" target="_blank" style="color:#667eea;">📍 View on Map</a>` : '';
  
  content.innerHTML = `
    <div class="order-ticket">
      <div class="ticket-header">
        <span class="ticket-id">${orderData.token}</span>
        <span class="ticket-date">${date}</span>
      </div>
      <div class="ticket-body">
        <div style="text-align:center; margin-bottom:20px;">
          <i class="fas fa-clock" style="font-size:48px; color:#f59e0b;"></i>
          <h3 style="color:white; margin-top:12px;">Order Received!</h3>
          <p style="color:rgba(255,255,255,0.9); font-size:13px;">Awaiting admin confirmation</p>
        </div>
        
        <div class="ticket-row">
          <span>Order ID:</span>
          <span style="font-weight:800;">${orderData.orderId}</span>
        </div>
        <div class="ticket-row">
          <span>Customer:</span>
          <span>${orderData.customerName}</span>
        </div>
        <div class="ticket-row">
          <span>Phone:</span>
          <span>${orderData.customerPhone}</span>
        </div>
        ${orderData.customerEmail ? `
        <div class="ticket-row">
          <span>Email:</span>
          <span>${orderData.customerEmail}</span>
        </div>
        ` : ''}
        <div class="ticket-row">
          <span>Address:</span>
          <span style="max-width:180px;">${orderData.customerAddress}</span>
        </div>
        ${locationLink ? `
        <div class="ticket-row">
          <span>Location:</span>
          <span>${locationLink}</span>
        </div>
        ` : ''}
        
        <div style="margin:16px 0; padding:12px 0; border-top:2px dashed rgba(255,255,255,0.3); border-bottom:2px dashed rgba(255,255,255,0.3);">
          ${itemsHtml}
        </div>
        
        <div class="ticket-row">
          <span>Subtotal:</span>
          <span>PKR ${orderData.subtotal.toFixed(2)}</span>
        </div>
        <div class="ticket-row">
          <span>Delivery:</span>
          <span>PKR ${orderData.deliveryCharge.toFixed(2)}</span>
        </div>
        <div class="ticket-total">
          <span>Total</span>
          <span>PKR ${orderData.total.toFixed(2)}</span>
        </div>
      </div>
      <div style="text-align:center; margin-top:20px; font-size:12px; opacity:0.9;">
        <i class="fas fa-shield-alt"></i> Payment: ${getPaymentMethodName(orderData.paymentMethod)}
      </div>
    </div>
    
    <div style="margin-top:20px; background:#fef3c7; padding:16px; border-radius:12px;">
      <div style="display:flex; align-items:center; gap:8px; color:#92400e; margin-bottom:8px;">
        <i class="fas fa-info-circle"></i>
        <span style="font-weight:700;">What's Next?</span>
      </div>
      <div style="font-size:13px; color:#b45309;">
        Your order has been received and is waiting for admin confirmation. 
        You will be notified once confirmed. You can track your order status in the Delivery section.
      </div>
    </div>
    
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button onclick="downloadOrderTicket('${orderData.token}')" style="flex:1; padding:14px; background:#f1f5f9; color:#475569; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
        <i class="fas fa-download"></i> Save Ticket
      </button>
      <button onclick="window.navigateTo('deliveryPage')" style="flex:1; padding:14px; background:var(--whatsapp-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
        <i class="fas fa-truck"></i> Track Order
      </button>
    </div>
  `;
  
  openModal('orderConfirmationModal');
}

// ===== LOAD PAGES =====
function loadHomePage() {
  const featuredProducts = document.getElementById('featuredProducts');
  const products = card.products || [];
  featuredProducts.innerHTML = '';
  
  products.slice(0, 4).forEach((product, index) => {
    featuredProducts.appendChild(createProductCard(product, index));
  });
}

function loadProductsPage() {
  const allProducts = document.getElementById('allProducts');
  const products = card.products || [];
  allProducts.innerHTML = '';
  products.forEach((product, index) => {
    allProducts.appendChild(createProductCard(product, index));
  });
}

function loadAboutPage() {
  document.getElementById('aboutContent').innerHTML = `
    <div style="background:white; border-radius:16px; padding:24px; margin-bottom:16px; box-shadow:var(--shadow-sm);">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
        <div style="width:50px; height:50px; background:var(--primary-gradient); border-radius:12px; display:flex; align-items:center; justify-content:center;">
          <i class="fas fa-store" style="font-size:24px; color:white;"></i>
        </div>
        <div>
          <h2 style="font-size:20px; font-weight:800; color:var(--dark-color);">${card.businessName || card.name || 'Business'}</h2>
          <p style="color:#64748b; font-size:14px;">${card.business?.type || 'Premium Business'}</p>
        </div>
      </div>
      <p style="color:#475569; line-height:1.7; font-size:15px;">${card.business?.about || 'Welcome to our business. We provide premium products and services with quality assurance.'}</p>
    </div>
  `;
  
  if (card.businessHours) {
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const businessHours = document.getElementById('businessHours');
    businessHours.innerHTML = '';
    
    const today = new Date().getDay();
    
    card.businessHours.forEach((day, index) => {
      if (index < days.length) {
        const dayName = days[index];
        const isToday = index === (today === 0 ? 6 : today - 1);
        
        const hourItem = document.createElement('div');
        hourItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding: 12px;
          border-radius: 12px;
          ${isToday ? 'background: #f0f9ff; border-left: 4px solid #3b82f6;' : 'border-bottom: 1px solid #e2e8f0; padding-bottom: 12px;'}
        `;
        
        if (!day || day.status === 'closed') {
          hourItem.innerHTML = `
            <span style="font-weight:700; color:#475569; display:flex; align-items:center; gap:8px;">
              ${isToday ? '<span style="background:#3b82f6; width:8px; height:8px; border-radius:50%;"></span>' : ''}
              ${dayName}
            </span>
            <span style="color:#ef4444; font-weight:600; background:#fee2e2; padding:6px 16px; border-radius:30px; font-size:13px;">
              <i class="fas fa-clock"></i> Closed
            </span>
          `;
        } else {
          let startTime = day.start || '09:00';
          let endTime = day.end || '18:00';
          
          hourItem.innerHTML = `
            <span style="font-weight:700; color:#475569; display:flex; align-items:center; gap:8px;">
              ${isToday ? '<span style="background:#10b981; width:8px; height:8px; border-radius:50%;"></span>' : ''}
              ${dayName}
            </span>
            <span style="color:#10b981; font-weight:700; background:#d1fae5; padding:6px 20px; border-radius:30px; font-size:13px;">
              <i class="fas fa-clock"></i> ${startTime} - ${endTime}
            </span>
          `;
        }
        
        businessHours.appendChild(hourItem);
      }
    });
  }
  
  if (card.holidays && card.holidays.length > 0) {
    const holidaysList = document.getElementById('holidaysList');
    holidaysList.innerHTML = '';
    card.holidays.forEach(holiday => {
      if (holiday.name && holiday.date) {
        const date = new Date(holiday.date);
        const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        const holidayItem = document.createElement('div');
        holidayItem.style = "display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;";
        holidayItem.innerHTML = `
          <span style="font-weight:600; color:#475569;">
            <i class="fas fa-calendar-times" style="color:#ef4444; margin-right:8px;"></i>
            ${holiday.name}
          </span>
          <span style="color:#64748b; background:#f1f5f9; padding:6px 16px; border-radius:30px; font-size:12px;">
            ${formattedDate}
          </span>
        `;
        holidaysList.appendChild(holidayItem);
      }
    });
  }
}

function loadContactPage() {
  const phoneEl = document.getElementById('contactPhone');
  const emailEl = document.getElementById('contactEmail');
  const addressEl = document.getElementById('contactAddress');
  
  if (phoneEl) phoneEl.textContent = card.phone || 'Not available';
  if (emailEl) emailEl.textContent = card.email || 'Not available';
  if (addressEl) addressEl.textContent = card.address || 'Not available';
  
  const socialGrid = document.getElementById('socialGrid');
  const socialMedia = card.socialMedia || {};
  socialGrid.innerHTML = '';
  
  const platforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', label: 'Facebook', bg: '#1877F2' },
    { key: 'instagram', icon: 'fab fa-instagram', label: 'Instagram', bg: '#E4405F' },
    { key: 'twitter', icon: 'fab fa-twitter', label: 'Twitter', bg: '#1DA1F2' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', label: 'LinkedIn', bg: '#0A66C2' },
    { key: 'youtube', icon: 'fab fa-youtube', label: 'YouTube', bg: '#FF0000' },
    { key: 'tiktok', icon: 'fab fa-tiktok', label: 'TikTok', bg: '#000000' }
  ];
  
  platforms.forEach(platform => {
    const url = socialMedia[platform.key];
    if (url && url.trim()) {
      const link = document.createElement('a');
      link.href = url.includes('://') ? url : `https://${url}`;
      link.target = '_blank';
      link.style = "text-decoration:none; color:inherit;";
      link.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px; background:white; border-radius:12px; box-shadow:var(--shadow-sm); transition:all 0.3s;">
          <div style="width:40px; height:40px; background:${platform.bg}; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;">
            <i class="${platform.icon}"></i>
          </div>
          <div style="font-size:12px; font-weight:600; color:var(--dark-color);">${platform.label}</div>
        </div>
      `;
      socialGrid.appendChild(link);
    }
  });
}

// ===== ADMIN FUNCTIONS =====
async function loadAdminPanel() {
  await loadOrdersFromDatabase();
  renderTokenList();
  updateTokenStats();
}

async function sendNotificationToAll() {
  const title = prompt('Notification Title:', 'New Update');
  const body = prompt('Notification Message:', 'Check out our latest products!');
  
  if (title && body) {
    showNotification('✅ Notification feature coming soon!');
    addInnerNotification('Notification', `"${title}"`, 'info');
  }
}

// ===== LOGIN SYSTEM =====
function toggleLogin() {
  if (isAdminLoggedIn) {
    if (confirm("Are you sure you want to logout?")) {
      logoutAdmin();
    }
  } else {
    navigateTo('loginPage');
  }
}

function updateLoginUI() {
  const loginIcon = document.getElementById('loginIcon');
  const loginBtn = document.getElementById('loginBtn');
  
  if (isAdminLoggedIn) {
    loginIcon.className = 'fas fa-sign-out-alt';
    loginBtn.title = 'Logout';
  } else {
    loginIcon.className = 'fas fa-sign-in-alt';
    loginBtn.title = 'Login';
  }
}

function attemptLogin() {
  const passwordInput = document.getElementById('adminPasswordInput');
  const enteredPassword = passwordInput.value;
  
  if (enteredPassword === businessAdminPassword) {
    isAdminLoggedIn = true;
    isolatedLocalStorage.setItem('isAdminLoggedIn', 'true');
    updateLoginUI();
    showNotification('✅ Login successful!');
    addInnerNotification('Admin Login', 'You have logged in as administrator', 'success');
    navigateTo('adminPage');
  } else {
    showNotification('❌ Incorrect password. Try again.');
    passwordInput.value = '';
    passwordInput.focus();
  }
}

function handleLoginKeypress(event) {
  if (event.key === 'Enter') attemptLogin();
}

function logoutAdmin() {
  isAdminLoggedIn = false;
  isolatedLocalStorage.removeItem('isAdminLoggedIn');
  updateLoginUI();
  showNotification('👋 Logged out successfully');
  addInnerNotification('Logged Out', 'You have been logged out', 'info');
  navigateTo('homePage');
}

// ===== NAVIGATION =====
let lastBackPress = 0;

function initializeRouting() {
  window.addEventListener('hashchange', handleHashChange);
  
  setTimeout(() => {
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      handleHashChange();
    } else {
      window.location.hash = '#home';
    }
  }, 100);
}

function handleHashChange() {
  const hash = window.location.hash.replace('#', '');
  const pageMap = {
    'home': 'homePage',
    'products': 'productsPage',
    'cart': 'cartPage',
    'customer-info': 'customerInfoPage',
    'payment': 'paymentPage',
    'about': 'aboutPage',
    'contact': 'contactPage',
    'delivery': 'deliveryPage',
    'admin': 'adminPage',
    'login': 'loginPage'
  };
  
  if (pageMap[hash]) {
    if (currentPage !== pageMap[hash]) {
      navigateToDirect(pageMap[hash]);
    }
  } else {
    window.location.hash = '#home';
  }
}

function navigateToDirect(pageId) {
  if (currentPage === pageId) return;
  
  const oldPage = document.getElementById(currentPage);
  const newPage = document.getElementById(pageId);
  
  if (!newPage) return;
  
  if (oldPage) {
    oldPage.classList.remove('active');
    oldPage.classList.add('slide-out');
  }
  
  setTimeout(() => {
    if (oldPage) oldPage.classList.remove('slide-out');
    newPage.classList.add('active');
    currentPage = pageId;
    
    const backBtn = document.getElementById('headerBackBtn');
    if (backBtn) backBtn.style.display = pageId !== 'homePage' ? 'flex' : 'none';
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const navMap = { 
      'homePage': 0, 
      'productsPage': 1, 
      'cartPage': 2, 
      'aboutPage': 3, 
      'contactPage': 4 
    };
    if (navMap[pageId] !== undefined) {
      const navItems = document.querySelectorAll('.nav-item');
      if (navItems[navMap[pageId]]) navItems[navMap[pageId]].classList.add('active');
    }
    
    document.getElementById('notificationDrawer').classList.remove('open');
    
    if (pageId === 'homePage') loadHomePage();
    else if (pageId === 'productsPage') loadProductsPage();
    else if (pageId === 'cartPage') loadCartPage();
    else if (pageId === 'customerInfoPage') loadCustomerInfo();
    else if (pageId === 'paymentPage') loadPaymentPage();
    else if (pageId === 'aboutPage') loadAboutPage();
    else if (pageId === 'contactPage') loadContactPage();
    else if (pageId === 'deliveryPage') loadDeliveryStatus();
    else if (pageId === 'adminPage' && isAdminLoggedIn) loadAdminPanel();
    else if (pageId === 'adminPage' && !isAdminLoggedIn) navigateTo('loginPage');
  }, 300);
  
  navigationHistory.push(pageId);
}

function navigateTo(pageId) {
  const hashMap = {
    'homePage': 'home',
    'productsPage': 'products',
    'cartPage': 'cart',
    'customerInfoPage': 'customer-info',
    'paymentPage': 'payment',
    'aboutPage': 'about',
    'contactPage': 'contact',
    'deliveryPage': 'delivery',
    'adminPage': 'admin',
    'loginPage': 'login'
  };
  
  if (hashMap[pageId]) {
    window.location.hash = `#${hashMap[pageId]}`;
  }
}

function goBack() {
  const drawer = document.getElementById('notificationDrawer');
  if (drawer && drawer.classList.contains('open')) {
    toggleNotificationDrawer();
    return;
  }
  
  if (navigationHistory.length > 1) {
    navigationHistory.pop();
    const previousPage = navigationHistory[navigationHistory.length - 1];
    navigateTo(previousPage);
  } else {
    const now = Date.now();
    if (now - lastBackPress < 2000) {
      document.getElementById('exitModal').style.display = 'flex';
    } else {
      lastBackPress = now;
      showNotification('Press back again to exit');
    }
  }
}

function closeExitModal() {
  document.getElementById('exitModal').style.display = 'none';
}

function exitApp() {
  if (window.history.length > 1) {
    window.history.go(-1);
  } else {
    window.close();
  }
}

function closeInstallPermissionModal() {
  document.getElementById('installPermissionModal').style.display = 'none';
}

function acceptInstallPermissions() {
  document.getElementById('installPermissionModal').style.display = 'none';
  showNotification('✅ Thank you!');
  enableNotifications();
}

// ===== GENERATE DEVICE ID =====
function generateDeviceId() {
  let deviceId = localStorage.getItem('customer_device_id');
  if (!deviceId) {
    deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('customer_device_id', deviceId);
  }
  return deviceId;
}

// ===== WHATSAPP & CONTACT ACTIONS =====
function openWhatsAppChat() {
  if (card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    const message = `Hello ${card.businessName || card.name}, I'm interested in your products/services.`;
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  }
}

function makeCall() {
  if (card.phone) window.open(`tel:${card.phone}`);
}

function sendEmail() {
  if (card.email) {
    const subject = encodeURIComponent(`Inquiry - ${card.businessName || 'Business'}`);
    window.open(`mailto:${card.email}?subject=${subject}`, '_blank');
  }
}

function openMap() {
  if (card.address) window.open(`https://maps.google.com/?q=${encodeURIComponent(card.address)}`, '_blank');
}

// ===== INITIALIZATION =====
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(location.search);
  let id = urlParams.get("id") || localStorage.getItem("lastCardId");
  
  if (!id) {
    document.body.innerHTML = "<div style='padding:40px; text-align:center; color:white; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);'><h2>Card not found</h2><p>No ID provided</p></div>";
    return;
  }
  
  console.log("Loading card with UUID:", id);
  
  localStorage.setItem("lastCardId", id);
  currentBusinessId = id;
  
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  
  isAdminLoggedIn = isolatedLocalStorage.getItem('isAdminLoggedIn') === 'true';
  
  const savedNotifications = isolatedLocalStorage.getItem('innerNotifications');
  if (savedNotifications) {
    innerNotifications = JSON.parse(savedNotifications);
    unreadNotifications = innerNotifications.filter(n => !n.read).length;
  }
  
  const savedCustomer = isolatedLocalStorage.getItem('customerInfo');
  if (savedCustomer) {
    try {
      customerInfo = JSON.parse(savedCustomer);
    } catch (e) {
      console.error('Error loading customer info:', e);
    }
  }
  
  setTimeout(async () => {
    const { data, error } = await supa
      .from("cards")
      .select("*")
      .eq("id", id)
      .single();
    
    if (error || !data) {
      document.body.innerHTML = "<div style='padding:40px; text-align:center; color:white; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);'><h2>Card not found</h2><p>Invalid ID: " + id + "</p></div>";
      return;
    }
    
    card = JSON.parse(data.data);
    card.id = data.id;
    
    businessAdminPassword = generateAdminPassword(card.id);
    
    const hintEl = document.getElementById('passwordHint');
    if (hintEl) {
      const uuidFirst6 = card.id.substring(0, 6).toLowerCase();
      hintEl.innerHTML = `
        <div style="background:#f1f5f9; padding:10px; border-radius:8px;">
          <small>Admin Password Hint:</small><br>
          <code>business123_${uuidFirst6.substring(0,4)}***</code>
        </div>
      `;
    }
    
    await loadOrdersFromDatabase();
    setupOrdersSubscription();
    await renderApp();
    
    initializeRouting();
    
    navigationHistory.push('homePage');
    updateCartCount();
    updateLoginUI();
    updateNotificationBellCount();
    updateDeliveryIcon();
    
    setTimeout(() => { checkForDeliveries(); }, 1000);
    
    if (innerNotifications.length === 0) {
      addInnerNotification('Welcome!', 'Browse products and enjoy shopping', 'info');
    }
    
    setTimeout(() => {
      if (!isPWAInstalled() && deferredPrompt && !installButtonShown) {
        document.getElementById('installPermissionModal').style.display = 'flex';
      }
    }, 3000);
  }, 2000);
});

async function renderApp() {
  setupDynamicPWA(card);
  
  const headerEl = document.getElementById('businessHeader');
  if (headerEl) headerEl.textContent = card.businessName || card.name || "Premium Business";
  
  const photo = document.getElementById('photo');
  if (card.profileImage) {
    photo.src = card.profileImage;
    photo.style.display = 'block';
  } else {
    photo.style.display = 'none';
  }
  
  const nameEl = document.getElementById('name');
  const businessEl = document.getElementById('business');
  if (nameEl) nameEl.textContent = card.name || "";
  if (businessEl) businessEl.textContent = card.businessName || "";
  
  loadHomePage();
}

// ===== INTERVALS =====
setInterval(checkForDeliveries, 30000);
</script>
</body>
</html>
